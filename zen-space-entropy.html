<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Space Entropy Defense</title>
    
    <!-- Google Fonts - Press Start 2P -->    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/space-tank-battle-icon.png">
    
    <!-- Social Media Preview -->
<meta property="og:title" content="Space Entropy Defense">
<meta property="og:description" content="Engage in satisfyingly mindless destruction of enemy spaceships. Achieve a Zen-like flow state by mowing down a constant onslaught of dangerous aliens.">
<meta property="og:url" content="https://robby3000.github.io/html-fun/space-tanks.html">
<meta property="og:type" content="website">
<meta property="og:site_name" content="Space Entropy Defense">
<meta property="og:locale" content="en_US">

<!-- Primary Meta Tags -->
<meta property="og:image" content="https://robby3000.github.io/html-fun/images/space-tank-battle.png">
<meta property="og:image:secure_url" content="https://robby3000.github.io/html-fun/images/space-tank-battle.png">
<meta property="og:image:width" content="1024">
<meta property="og:image:height" content="1024">
<meta property="og:image:alt" content="Space Entropy Defense Game Screenshot">
<meta property="og:image:type" content="image/png">

<!-- Twitter Card tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://robby3000.github.io/html-fun/images/space-tank-battle.png">
<meta name="twitter:title" content="Space Entropy Defense">
<meta name="twitter:description" content="Engage in satisfyingly mindless destruction of enemy spaceships. Achieve a Zen-like flow state by mowing down a constant onslaught of dangerous aliens.">
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            touch-action: none;
            font-family: 'Press Start 2P', cursive;
        }
        #game-container {
            position: absolute;
            width: 100vw;
            height: 100dvh; /* Use dvh for dynamic viewport height */
        }
        canvas { /* Or #gameCanvas if you prefer to be more specific */
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; /* Ensure canvas is at the very back within its container */
        }
                /* Star Wars Crawl CSS - START */
                #star-wars-crawl-container {
            position: absolute;
            bottom: 0; /* Aligns to the bottom of #game-container */
            left: 50%;
            transform: translateX(-50%); /* Center the container */
            width: 95vw;
            max-width: 1200px;
            height: 80vh; /* Define the vertical space for the perspective effect */
            perspective: 1000px;
            overflow: hidden; /* Crucial: hides the text before it enters and after it leaves */
            z-index: 1; /* Above canvas (z-index: 0), below game controls/UI */
            pointer-events: none; /* Text should not be interactive */
            display: none; /* Initially hidden, will be shown by JavaScript */
            /* CSS Mask removed, opacity will be handled by the animation */
        }

        #star-wars-crawl-content {
            position: absolute;
            top: 100%; /* Start fully below the container's visible area */
            left: -15%;
            width: 130%; /* Pushing content width further */
            text-align: justify; /* Classic crawl text alignment */
            color: #ffc070; /* Requested text color */
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; /* Common, readable sans-serif */
            font-size: clamp(30px, 6vw, 60px); /* bigger responsive font size */
            font-weight: bold;
            line-height: 1.6; /* Spacing between lines */
            transform-origin: 50% 100%; /* Rotate around bottom-center for the perspective effect */
            transform: rotateX(55deg) translateY(0%); /* More extreme 3D angle */
            /* Animation will be applied via JS or by adding a class */
        }

        /* The actual animation for the crawl */
        @keyframes crawlAnimation {
            0% {
                transform: rotateX(55deg) translateY(0%); /* Consistent with more extreme 3D angle */
                opacity: 1;
            }
            80% { /* Text remains fully opaque for a good portion of its journey */
                opacity: 1;
            }
            100% {
                transform: rotateX(55deg) translateY(-250vh); /* INCREASED TRAVEL to compensate for foreshortening */
                opacity: 0;
            }
        }
        /* Star Wars Crawl CSS - END */
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 12px;
            pointer-events: none;
            line-height: 1.5;
        }
        #health {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 100px;
            height: 20px;
            border: 2px solid white;
        }
        #health-bar {
            height: 100%;
            width: 100%;
            background: red; /* Initial, will be updated */
        }
        #controls {
            position: fixed;
            /* bottom: 20px; dynamically set by JS */
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 0 20px;
            box-sizing: border-box;
            z-index: 100;
            pointer-events: auto;
        }
        .control-btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 16px;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        /* Styles for #game-over are removed as the element is being removed. */

        /* Styles for the combined leaderboard screen */
        #leaderboardScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh; /* MODIFIED: Changed from min-height, or use 100% */
            background: rgba(0,0,0,0.85); /* MODIFIED: Slightly darker like info-modal parent */
            z-index: 1000;
            flex-direction: column;
            justify-content: flex-start; /* Keeps content starting from top */
            align-items: flex-start; /* MODIFIED: Align wrapper to the start (top) */
            color: white;
            font-family: 'Press Start 2P', cursive;
            padding: 5vh 0; /* MODIFIED: Top/bottom padding for the screen, wrapper handles side margins */
            box-sizing: border-box;
            overflow-y: auto; /* This allows the screen itself to scroll if wrapper is too tall */
        }
        #leaderboard-content-wrapper {
            background: rgba(20, 20, 50, 0.8); /* Similar to info-modal's content box */
            padding: 20px;
            border-radius: 10px;
            max-width: 500px; /* Adjust as needed for leaderboard content */
            width: 90%; /* Responsive width */
            margin: 0 auto 10vh; /* Auto horizontal margins for centering, bottom margin for scroll room */
            text-align: center;
            position: relative;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center direct children like buttons */
        }
        /* Info Button on Leaderboard - new styling for flow position */
        #leaderboardScreen .info-button-leaderboard {
            position: relative; /* Changed from absolute */
            top: auto; /* Reset */
            padding: 8px 18px; /* Adjusted padding */
            font-size: 0.9em;
            background: rgba(255,255,255,0.15); /* Keep subtle background */
            color: white;
            border: 1px solid rgba(255, 55, 55, 0.76); /* Your red border */
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            z-index: auto; /* Reset */
            display: block; /* To allow margin auto */
            width: fit-content;
            margin: 10px auto 60px auto; /* Top: 10px, Right: auto, Bottom: 60px, Left: auto */
        }
        #leaderboardScreen h2 {
            font-size: 1.8em; /* Reduced */
            text-shadow: 0 0 8px #00ff00, 0 0 15px #00ff00; 
            margin-top: 45px; /* Adjusted margin to make space for info button */
            margin-bottom: 15px;
        }
        #leaderboardScreen .score-display {
            font-size: .8em; /* Reduced */
            margin-bottom: 15px;
            line-height: 1.1;
            text-align: center;
        }
        #leaderboardScreen #high-score-alert h3 {
            font-size: 1.2em; /* Reduced */
            color: #ff0000; 
            animation: flash 1s infinite; 
            margin-bottom: 10px;
        }
        #leaderboardScreen #high-score-form p {
            font-size: 0.9em; /* Reduced */
            margin-bottom: 8px;
        }
        #leaderboardScreen #high-score-form input[type="text"] {
            font-size: 1em; /* Reduced */
            padding: 5px;
            background: #333; /* Added for visibility */
            color: #0f0;    /* Added for visibility */
            border: 1px solid #0f0; /* Added for visibility */
            font-family: 'Press Start 2P', cursive;
        }
        #leaderboardScreen #high-score-form button {
            font-size: 0.9em; /* Reduced */
            padding: 6px 10px;
            background: #00aa00; /* Added for visibility */
            color: white; /* Added for visibility */
            border: 1px solid #0f0; /* Added for visibility */
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
        }
        #leaderboardScreen #leaderboard-container {
            width: 90%; 
            max-width: 450px; /* Slightly wider */
            margin-bottom: 15px;
        }
        #leaderboardScreen #leaderboard-container h3 {
            font-size: .8em; /* Reduced */
            margin-bottom: 8px;
            text-align: center; 
        }
        #leaderboardScreen #leaderboardTable th, /* Assuming you might add a table header later */
        #leaderboardScreen #leaderboardTable td, /* Assuming leaderboard-list might become a table */
        #leaderboardScreen .leaderboard-row { /* Styling existing rows */
            padding: 4px; /* Reduced */
            font-size: 0.8em; /* Reduced */
        }
        #leaderboardScreen #play-again-btn {
            padding: 8px 18px; /* Reduced */
            font-size: 1em; /* Reduced */
            margin-top: 10px; /* Added some top margin */
            background: #00aa00; /* Added for visibility */
            color: white; /* Added for visibility */
            border: 1px solid #0f0; /* Added for visibility */
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
        }
        #leaderboardScreen .leaderboard-tabs button { /* Style for tab buttons */
            flex: 1;
            padding: 8px;
            background: #222;
            border: 1px solid #00ff00;
            color: white;
            cursor: pointer;
            font-size: 0.8em; /* Reduced */
            font-family: 'Press Start 2P', cursive;
        }
        #leaderboardScreen .leaderboard-tabs button.active {
            background: #00aa00 !important;
        }
        #sound-options {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            z-index: 100;
            display: flex;
            align-items: center;
        }
        /* Style for the restart button on the game over screen */
        #restart-game-btn {
            margin-top: 20px; /* Keep consistent with original restart-btn style if desired */
            margin-bottom: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
        }
        @media (min-width: 1024px) {
            .control-btn {
                display: none;
            }
            #controls { /* Hide the whole controls bar on desktop */
                display: none;
            }
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .leaderboard-tab.active {
            background: #00aa00 !important;
        }
        
        .leaderboard-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 5px;
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
        }
        
        .leaderboard-row .rank {
            width: 30px;
        }
        
        .leaderboard-row .name {
            flex: 1;
            text-align: left;
            padding-left: 10px;
        }
        
        .leaderboard-row .score {
            text-align: right;
        }
        
        .top-three {
            color: #ffff00;
            font-weight: bold;
        }
        
        .leaderboard-empty {
            text-align: center;
            padding: 20px;
            color: #aaa;
        }

        /* Write Modal Rework Styles */
        .write-modal-content-box {
            background: rgba(30, 30, 50, 0.95);
            padding: 25px;
            border-radius: 3px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            color: white;
            position: relative;
            box-sizing: border-box;
            box-shadow: inset 0 0 0 1px #FFE81F, inset 0 0 5px rgba(0,0,0,0.5);
        }

        .write-modal-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 24px;
            margin-top: 0;
            margin-bottom: 10px;
            color: #FFE81F;
        }

        .write-modal-subtitle {
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            margin-bottom: 15px;
            color: #ccc;
        }

        .write-modal-info {
            font-size: 11px;
            margin-bottom: 20px;
            color: #aaa;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            border-bottom: 1px solid #FFE81F;
            padding-bottom: 15px;
        }

        #text-blocks-container::-webkit-scrollbar {
          width: 8px; /* Thin scrollbar */
        }

        #text-blocks-container::-webkit-scrollbar-track {
          background: rgb(20, 20, 35); /* Dark track */
        }

        #text-blocks-container::-webkit-scrollbar-thumb {
          background-color: #FFE81F; /* Yellow accent thumb */
          border-radius: 4px;
        }

        /* Text Block Editor Item Styles */
        .text-block-editor-item {
            background: rgb(15,15,30); /* Darker than modal bg */
            border: 1px solid #444; /* Darker gray border */
            border-radius: 3px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .block-label {
            font-family: 'Press Start 2P', cursive;
            color: #ccc;
            font-size: 12px;
            margin-bottom: 8px; /* Increased slightly for better separation */
            display: block;
            text-align: left; /* Align label to the left */
        }

        .block-textarea {
            width: 100%;
            min-height: 80px;
            box-sizing: border-box;
            background: rgb(20, 20, 35); /* Dark gray/blue */
            color: #DDDDDD;
            border: 1px solid #444;
            padding: 10px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; /* Clean sans-serif */
            border-radius: 3px; /* Match other elements */
        }

        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .alignment-group {
            display: flex;
            align-items: center;
        }

        .alignment-label {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: #bbb;
            font-size: 11px;
            margin-right: 5px;
        }

        /* Existing .alignment-select class will be used, but we can add specific overrides if needed later */
        .alignment-select {
            padding: 5px 8px; /* Adjusted padding */
            background-color: rgb(20, 20, 35); /* Match textarea */
            color: #DDDDDD; /* Match textarea */
            border: 1px solid #444; /* Match textarea */
            border-radius: 3px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            font-size: 11px; /* Match other control text */
        }

        .char-counter {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: #aaa;
            font-size: 11px;
        }


        .write-modal-footer {
            border-top: 1px solid #FFE81F;
            padding-top: 20px;
            margin-top: 20px; /* Space above the border */
            display: flex;
            justify-content: space-between; /* Or space-around if preferred */
            align-items: center;
            width: 100%;
        }

        .retrofuturistic-button {
            font-family: 'Press Start 2P', cursive;
            border-radius: 3px; /* Sharper corners */
            padding: 8px 15px;
            font-size: 11px; /* Consistent small button size */
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            background: rgb(35, 35, 60); /* Base dark background */
            color: #DDDDDD; /* Default text color */
            border: 1px solid #50C8C8; /* Default border (secondary accent) */
        }

        .retrofuturistic-button:hover {
            filter: brightness(1.2);
        }

        .action-save {
            border-color: #FFE81F; /* Primary accent */
            color: #FFE81F;
        }
        .action-save:hover {
            background-color: #FFE81F;
            color: rgb(35, 35, 60);
        }

        .action-close {
            border-color: #FF6B6B; /* Destructive accent */
            color: #FF6B6B;
        }
        .action-close:hover {
            background-color: #FF6B6B;
            color: rgb(35, 35, 60);
        }

        @media (max-width: 480px) { /* Adjust breakpoint as needed for small mobile */
            .retrofuturistic-button {
                font-size: 9px;
                padding: 6px 8px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <!-- Star Wars Crawl HTML - START -->
        <div id="star-wars-crawl-container">
            <div id="star-wars-crawl-content">
                <!-- Placeholder text will be injected by JavaScript -->
            </div>
        </div>
        <!-- Star Wars Crawl HTML - END -->
    </div>
            
    <div id="ui">
        <div>Score: <span id="score">0</span></div>
    </div>
    <button id="sound-toggle" style="position: absolute; top: 50px; left: 10px; cursor: pointer; font-size: 20px; user-select: none; background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 5px; z-index: 100; border: none; color: white;">
        🔊
    </button>
    <!-- Fart Sound Checkbox -->
<div id="sound-options">
    <input type="checkbox" id="fart-sound-checkbox" style="margin-right: 5px;">
    <label for="fart-sound-checkbox">Farts</label>
</div>
    <div id="health">
        <div id="health-bar"></div>
    </div>
    <div id="bullets-display" style="position: absolute; top: 40px; right: 10px; font-size: 24px; color: #CCCCCC; text-shadow: 0 0 10px #00FF00, 0 0 20px #00FF00;">20</div>
    <div id="controls">
        <div class="control-btn" id="left-btn">&lt;</div>
        <div class="control-btn" id="fire-btn" style="background: rgba(255, 50, 50, 0.7);">FIRE</div>
        <div class="control-btn" id="right-btn">&gt;</div>
    </div>
    <div id="start-screen" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgb(0, 0, 0); display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; font-size: 24px; overflow-y: auto; padding: 20px; box-sizing: border-box; text-align: center; z-index: 1000;">
        <h1 style="margin: 0 0 30px 0; font-size: 28px; text-shadow: 0 0 10px #4CAF50; text-align: center; line-height: 1.4;">SPACE ENTROPY DEFENSE</h1>
        <img src="images/space-tank-battle-800.png" alt="Space Tank Battle Preview" style="max-width: 80%; max-height: 40vh; height: auto; border-radius: 5px; margin: 0 0 30px; border: 2px solid #4CAF50; box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);">
        <button id="start-btn" style="margin-bottom: 20px; padding: 10px 30px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 0 10px rgba(76, 175, 80, 0.5); font-family: 'Press Start 2P', cursive;">Start Game</button>
        <button id="info-btn-start" style="padding: 5px 15px; font-size: 12px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 5px; cursor: pointer; font-family: 'Press Start 2P', cursive;">info</button>
        <button id="open-write-modal-button" style="margin-top: 20px; padding: 10px 30px; font-size: 16px; background: #FFD700; color: black; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); font-family: 'Press Start 2P', cursive;">Write Your Story</button>
    </div>
    
    <!-- Old game-over div removed -->
    
    <div id="info-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 2000; justify-content: center; align-items: flex-start; overflow-y: auto; padding-top: 10vh;">
        <div style="background: rgba(50, 50, 80, 0.9); padding: 20px; border-radius: 10px; max-width: 500px; width: 90%; margin: 0 auto 20vh; text-align: center; color: white; position: relative; box-sizing: border-box;">
            <h2 style="margin-top: 0; font-size: 18px; margin-bottom: 15px; line-height: 1.4;">SPACE ENTROPY DEFENSE</h2>
            <img src="images/space-tank-battle-2-800.png" alt="Space Entropy Defense Preview" style="max-width: 100%; height: auto; border-radius: 5px; margin-bottom: 15px; border: 2px solid #4CAF50; box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);">
            <p style="font-size: 12px; line-height: 1.8;">Engage in satisfyingly mindless destruction of enemy spaceships. Achieve a Zen-like flow state by mowing down a constant onslaught of dangerous aliens. </p>
            <p style="font-size: 12px; line-height: 1.8;">You are the last defense against the hordes of the Galactic Overlords.  If you fail, entropy will rise to maximum - resulting in the heat death of the universe T_T</p>
            <p style="font-size: 12px; line-height: 1.8;">Shoot down the enemy spaceships. Keep an eye on your laser cannon ammo count at the top right, you get 2 more shots with every enemy spaceship that spawns. </p>
            <p style="font-size: 12px; line-height: 1.8;">The goal is to use this game as mind training therapy, and to be an extreme badass space hero. The continued existence of the universe is all down to your skill. </p>
            <p style="font-size: 12px; line-height: 1.8; margin-bottom: 20px;">Good luck!</p>
            <button id="close-modal" style="padding: 5px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; font-family: 'Press Start 2P', cursive; font-size: 12px; position: relative; z-index: 1001;">Close</button>
        </div>
    </div>

    <!-- Write Modal HTML -->
    <div id="write-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 2001; justify-content: center; align-items: center; flex-direction: column; overflow-y: auto; padding: 20px; box-sizing: border-box;">
        <div class="write-modal-content-box">
            <h2 class="write-modal-title">WRITE</h2>
            <p class="write-modal-subtitle">Craft your Star Wars intro</p>
            <p class="write-modal-info">500 characters max per text block. Up to 10 blocks.</p>
            
            <div id="text-blocks-container" style="margin-bottom: 20px; max-height: 40vh; overflow-y: auto; padding-right: 10px; /* For scrollbar */">
                <!-- Text blocks will be added here by JavaScript -->
            </div>
            
            <div class="write-modal-footer">
                <button id="new-text-block-button" class="retrofuturistic-button action-new">+block</button>
                <button id="save-crawl-text-button" class="retrofuturistic-button action-save">Save</button> 
                <button id="close-write-modal-button" class="retrofuturistic-button action-close">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Audio elements for sound effects -->
    <audio id="laser-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRoQJAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YWAJAACCfYJ+mLe2toZ2fXh7pLivsrCKcXh2dJWzrayxlHBydG9/qa2mrp93anNrdZ6uoquje2dwamyVrKGmpoFia2tnjKqho6eEZWlsZISmpaCmjWZnamVxmqWepJx0YGlkao6mnaKgfWFpZmSIp5+do4BiZWhff6Shm6WHYGNpXnugnpyikWNkZGNolqGdnqCBXmVjY2yenJ+boG9gY2NieKWYoZmgZ2BjZmB+opugnJhkZWBmX4ihnp2ejl9kY2NnmZ+fmqB3XGNiY22imJ+YoW5dZGNhcaWan5mea2FhZF98oZufm5lmYmBlYYignZyfhl1jYWVmnJ6gmKJ8XGZiZGqfm6CZonNeZGJicKCan5qecGFlYmRmmp+emp+KYGRhZGGNpJyemp1mYWRjYmyfnKGaoIVeZF9lYpGinJydl2NjYWRfc6GaoJqhf1xmYWVjj6CdnZ2UY2RhZV94opqgmaB6XmZhZGSTnp2cn4xfZF9lXoKimqCannBfY2FjZpmenJueiF5lX2ZehKOanpudbGBjYmFqm5ycnJyXZ2BiYmFrnJ2dnZ2aamFkYmRijqGan5qfdV5kYGVhi6GZn5mhe15mYGdefKCYnpigiFxjYWVgdqKcnpqfkGJhYWNiaJignZycmWdgY2NiaZifnJ2cm29fY2FlYIqjm56Zn3lcZGFlYYminJ+ZoHpeZmBmXX2jmJ+ZoIheZF9lYHSgnKCbnZZlXmJhZl59oZmdm52YaV9kX2Zff6GZn5mgjF9gYmJkYYehmZ+ZoJBjYWJiZWKNpJqemaF+WmViZWJmlJ+Zn5mhg15kYGNiaZehnJ2an3deZWBlYG6dnZudmp94XWNfZWBznpyenJ2YaV9lX2ZffKGbnpydmGlcY2FlX4GhnJuZmZhzXGRgZWBxmZyYnJedi2JgZWFmX3ufmZubmZt7XWZgZWJplJ6ZnZmck2hgZGFmYW+bnZmcmJyCYWVjY2Vki56ZnJqamHBeZGJmY2qSoJmdl56CYWJkY2ZhfqGbm5qZnHZeZmFmZGePoJiel56KY2JkYmdhdp2bnJyZnoVfY2JlZWSJnpiYmZaZdWJlZWNoYnqamZialpqQaWJmY2dlaI+dmJmYl5p9YWdlZWhjd5yamJqWmpBqYWZkaGVrjp2Xm5iYmHtgZ2RmZ2WBnJmZm5acf2RlZmRpY3OZnZibl5mUbmJmZWZoZISemZqZl5yDYmRmZWdkb5icmJuXmZZwYmdkZmhlg56YmpeUmIJhZmNnZWlliJ2WmJaWlo9nZ2VnZmllf5yWmZWYlJd5YmZmZ2dpa5CamJeYlpiKZWhlaGZqZYabl5mWmJWVa2RmaGZqZX2dlZqVmZSZdGJmZ2doZ3KamJmXmZSafmJpZmdnaGyVmpiYmJaYiGRoZGhmamd8m5iZl5iVmHdkaGZnaGdylpOUk5SSlI5oZmZoZ2locZOVlJWUlJOScmRpZ2lna2iJmZWXk5WTk29maGdpaGpqjJiVl5OWk5Z/ZWpma2hsZ3+blZeUl5OXfGRpZ2poa2h5mJaWlZaUlo5paGdqaWtodZmWl5WXk5aKaWlpaWlqam6QmJaWlZaUlnJmaWdqaWptkZmWlpKTkJV9ZWpnaWlra2yNl5KUkpSRlX1la2lqamtra4mXk5aSlJKTjm1pamlqamxsiZeTlZOVkpSPb2hraWtpbWl7mJWVlJSTlI5taGtobGltaXaVlJSVk5SSlHpna2lramxqdJOWlZWTlZGWfmZqaWxqa2xti5iUlZOVkpWBZWtqa2prbGuIlZCTkZGRkJF4aGxqbWxtbmuClZGTkpGSj5N8aGxsbG1sb2t9lZGTkpGSj5SBaWxsbG1sb2t5k5KSk5CTj5SGamttbG5sb2t2kpSTlJGTj5OKbmpsa25sbmxyjJWRlJGTkJKOcWltbG5sbm1wjJaSk5GTkZGQdGhua21sbm5uiJiRlJGUjnJphZCNj4yNjI2Mi29qbGtsbG1tbW+KkY6Ojo2OjI56aW1sbW1ubW9uiZGQkI+Pj42PgmttbG5tb21wbYOTkJGPkI+Oj4htbG1ubW9ucW17kpCRkJCPj4+McW1ubm5vbnBudpGRkY+Qj5COj3dsb21vbm9vcHGNkpGQkJCPj5B/bHBtb21wbnFufI+MjYyNjIyLjIZvbm9ub29wcHFyiI+Njo2NjY2MjHRscG9wb3Fwcm+Fko2PjY6MjouPgG5wbnBwcXBycHmQj46Ojo2OjI2Jcm5wcHBwcXFxc4mQjo+Oj42OjI16bnBvcXBxcHJxg5COj46OjY6NjYhzb3BwcXBycXJyh5COj46OjoqJh3JvcXBxcHJxcnF0iIyKjIqMiouKi4d0b3JxcnFzcnNyfo6MjIyLi4uLioyAcHJxcnJycnNzcoSPjI2LjIuMi4uJdXBycXJyc3J0c3eJjoyNjIyLjIqMgnFycXJycnNzdHKCj4uNjI2MjIuLi3dwcnJzcnNzc3N1hY+MjYyNi4yLjIZzcXJycnNzc3N0c4CLiYmJiYmIiYeJgnNyc3N0c3R0dHR1hoyJiomKiYmJiIl+cnNzc3R0dXR1dHiKi4qLioqJiomJiXtydHN0dHR1dHZ0eouKiouKioqKiYmJe3J0dHR0dXV1dnR6iouLi4qKiomKiYp/cnR0dHR1dXV2dHuLi4uLioqKiYWGg3d0dXV2dXZ2d3Z3d3uHiIeHh4eHhoeGh31zdnV2dnd2d3d3d32Ih4iHiIeHh4eGh4J1dnZ2dnd3d3d3d3qHiYiIiIiHiIeHhod9dXZ2d3d3d3d3d3iFiYiJiIiHiIeHh4d7dnd2d3d3d3h3eHeDioeJiIiHiIeIh4iAdnd2d3d3d3h3eHd6hIWFhYSFhISEhIOEgXh3eHd4eHh4eXh5eH2GhYaFhYWFhYSFhIWAeHh4eHh4eXh5eXp4gIeGhoWGhYWFhYWEhX53eXh5eHl5eXl5eXqDh4aGhoaFhYWFhYWFfnh5eHl4eXl5eXp5fIaGhoaGhoaGhYWFhYV8d3l4eXl5eXp5enl/hoKDgoKCgoKCgoKCgnt5eXl6eXp6enp6e3p9g4ODg4ODg4ODg4OCg355enp6enp6e3t7e3t8g4SDhIOEg4ODg4ODg4N9enp6e3t7e3t7e3t7gYWEhISEhISDg4ODg4J7ent6e3t7e3t7e3t7foSEhISEhISEhIODg4N+ent6e3t7e3s=" type="audio/wav">
    </audio>
    
    <audio id="enemy-laser-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRrADAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YYwDAACTd0tvjGBPhH9QYIxyS3CMZ0p8h2FMhINeToWFXFF9jVpWb5hbW16daFlYiodPYmOmVGVQkoRTYVqlZl1Xb6BcX1d1oVdjVHegW19YaqNqWGFYnYJTZFR7omBcX1iWkFVhW2Cgg1ZhXF+ihFdgXlqYlFlgXlp5q2ddXl9clZxaY1piXaKSW2FdYVyXn2BgXWFbeq14W2FdYVyQp2pdYV5hXI6qcltiXWJbdquOXmBgYGFdg62FXWFgYGFdd6qWZV5jX2JgYImsjGBgYWFgY12Ap5xsXWRfY19jXounmmtcZl1mXGhadJ2mi2BiY2FjYWNgZpuin21eZWBkYWRhZGGYoKOAXGZgZWFkY2NkYZKioJNgZWFkYmRjZGJlX4KmmaZ4YGVjZGNkY2VjZWNmlKSapXhhZWRkZWRlZGRlZGZhhaSboJ1wYWdjZmVlZWRmZGdjaGFzn56dn5tsY2dkZ2RnZWdlZmVmZmVnY3Ogm5+boY5jaGVnZWdlZ2ZnZmdmZ2ZnZmdmaJOgmp6bnphsZWhmaGZoZ2hnaGdoZ2hnaGhoaGhoaGiUnpqdmp2Zn3ZlamdpZ2loaWhoaGhoaGloaWhpaGloaWhqaGpmcpyam5qbmpuanJVraWlpaWlpaWlpaWlpaWlpaWlpaWlpaWppamlqaWlqaWppamhsZYOfmZyam5uam5mcmJ6NaGppamppamlqaWppamlqaWpqampqampqampqampqampqampqampqampqampramtqa2praWxpbWZ7nZmbmpqampqampqampqbmZuYnodnbWlramtqa2tra2tra2tra2tra2tra2tra2tra2tra2tra2tra2tra2tra2tra2tra2tra2tra2xsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxsbGxtbG1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbW1tbmxubG9pgJ2Ym5mamZqZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmYmZiZmJmYmZiZmJmXmZeakm5sbW1tbW1tbm1ubW1tbW1tbW1tbW1tbW1tbW1tbW1ubW5tbm1ubW5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5vbm9ub25vbg==" type="audio/wav">
    </audio>
    
    <audio id="enemy-destroyed-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRgwKAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YegJAACAgH+Af4B/gH+Af4B/gH+Af4B/f4B/gH+Af4B/gH+Af4B/gH+BfHBxcW5rbGtsa2xsbW1scXNyc3BxcHFycXJjXmFdVFVTX2lmaFhXVlpgYF51hH6BbHJpiLCnrZKNjJOurq6ur6+vxsjMuIaPiJ+oqKFKSUNjl4mVTTk7RH13fm1hYmJucXBxcXJxdnt5emNoX36ro6a0u7m2mp2ZrMG6v5mVkaHKxcuxn6WefXZ6fI6Fj1hERk6Oi5J6YWZjZWRlY1xeWnKFgIJramlteHR5YVlZX5CRko6JiomOj46YzMLQlml1b6erraqwqrR2Vl5ekpCTjYuJjHNrbWtkZmJ3jYWKRT87T3p3d4eTj5GTk5aIc3d0hYuIjqikrIlkbmiEhoeGi4iLgn1+fX9+foKNiY16dXV1Z2xjibKornJnaWpvb219ioaHZmNjZmtqa25zcHR5fXiGkZGQmZqckmpyZ5GuqKqfnKCQbHRslaajopCPkn5iaWVub25wcnVwiJqWl3VvcHeSiZNuYGFmmJmbkoSGhYKBgH9sc2eWv7W6fXJ1dHd2doGLh4qcnKGKYmtlcnV1c2VoZHN/fX13dHdwYGJgaW5tboyMkX5eY2BpbmtzoZ+kj3p+fGplZHCZlJmKf4OAjIiPelZcV3aGgIeenqGMb3Zyd3R2dnt6e3ZzdHNubW5tbG5qg5CMjHFzcHRzdnOPlpaPbXBtc3d3d4uOjop9f35/fn99cG9wcXRzdHd5eHhucW12enx6nqKmj01ZTXmOi4ySkJWAXGNdfYiFiIuLjYN4enloZGRpdXdyj6OenoWBhXhjZ2R8iYOHf4R+j56cnXxzdXmQi5CDen17hYSGfnJzcnqAfYCEh4SMk5KTgHl7e4WDhIF/gICRlJSPg4WEh4mIiH5/fYaRj5GEgIF+cHJveoaChHd3dXl8fnuJj4+NhoOGfnV2dnh7eH6RkZCUmpeaYVhWaJuUmZCNjYxycXBxbXFrnrKup2NpYXWFg4SIiomKjoyRcFZeXJqcoY9xdnN8fX5+jYqOg3l5enNzcXmRj5GJhIWEfHp7e319fIeOjIt4eXeAjYqNdXBwcnt7eYSQjI5ta2h4n5eegnR4d4SDhX95eXp4eHd7jIuNhX1/foWFhoN+f39/gH+Ah4eIgXN4c4+Yl5Frb2l+kY2PiIaIgnFzcXyDgYKKjIyGd3t3hoqKhnJycXZ6enmLj4+LgICBeXFzc5CRk4drcWx/hYWDcXJwdnt7eomMjodwcnB3e3p7hoiIhHx9fHt6ent9fn2BhoaFh4aHg3FycHl/fn+NjpCHc3ZzeXx7fYmJioiEhIV4c3N2iIeIhYKDgoeHiYFucW1/iYeHenp5enp7eoOGhYR3eHZ/iIaHdnNzd4KBgn99fn6GhoiAcnVyfH9+f4iHiX90d3V8fn1+gH+Af4B/gH19fH1+f36GioqIdHVzeoKBgYqNjYh0d3R9hYOEdnZ0e4iHiIWDhIJ6eXl6ent6iIyMiXt8e3t5enmJi4uGeXx5gIODgoGAgX56e3p8fXx9fX59goaFhoB/gH9+fX59fHx9g4OEgXx9fICCgYKFhIWBe318hoeIg3F0cXyEgoOFhYaCeHt4gYSEg4SDhH94eXh+gH+Ag4KCg4SDg3p6eXyCgYGIi4qJeHl4fIGAgISFhYN5enl9gYCBhoeHhYGCgn16e3p5enl/ioeKfnt8fISDhX98fH19fn1/goOCg4OEg4OChH1zdnOFjIqJfn9+gIGAgX9/fn+BgYCBgIGAgYCBf3t8eoeLiol7fHt+goGCfX18f4iHiIJ+f358fHt+hYSFgX9/gIGAgYCBgIF/f35+fH18gYWEhH18fX18fXyAgoGChYSGf3V3dn+CgYF8fXuChoWFf31+fXx9fICCgYKDgoN/eXp5fH18fomIioF5e3p9fHx+hYSGfnp7e4GBgoKDgoN/fn9/goGCgH1+fX5+f359fn1/gYCBgYKCgYGAgX58fH18fXyAhYSFgYCBf3d4d36EgoN+fn1/gYCBf35/fnx9fH6BgIGBgIGAfn5/fXx9fIODhIF7fHt+f39/gH+Af4B/gHt5eXuDgoOAfn9+fHt7fYB/gH+Af3+Af4B+fH18f4B/gIGAgX98fXyAgYCBhIOEf3t8fIGBgoGCgYJ/fn9/gYCBgIB/gH9/fn+DgoOBgIGAgH+Af4B/gH59fX6CgYKBf4B/f35+f4SDhH56e3qBgYKBfn9+f4B/f35/fn+BgIGAf4B/gH+Afn1+fYCAgYB9fn2AgYCBgoGCgYB/gH19fH6Eg4SDgoKCfHp6fIOCg4GAgIGBgYKAfn9+f4B/f31+fYCDgoKDgoOBent6f4OCg4CAf399fn2ChISDfH18fX5+fYGCgoF+f35/fn9/f4B/gIGAgX9+f3+CgYJ/fH18gYKCgX+AgH9+f36CgoOBfX59gIKBgYCAf4B/gH+Af4CAgoGCf3x9fIGCgoF/gIB/fn5/f4B/gIKBgoGAgYB/fn9+fX59goODgoCAgX99fn6BgoGCg4KDfnx9fYGAgYCAf4B/gH9/f3+Af4B/gH5/fn+AgH+AgYGAfn9+f4B/f4B/gH+Af4B+fX5+gIGAgYCAgYB/gH9+fn1/gYCBfn59foB/f4CBgIF+fn1+gIB/gYKBgX9/fn+BgIGAf3+AgH+Af35/foCAgYCAf4B+fX5+gYGCgH1+fX5+fn+Af4B/fn9+f3+Af4B/gH9+fn9/gH+AgYCBf35/f4B/gH9/gH+AgIGAfn9+f4B/gH+Af4CBgIF/fn9+f39+f4GAgX9+fn+AgH+AgYCBf39+f4GAgYB/gH+Af4B/gH+Af35+f4GAgX9+f35/gH+AgYCBf35/f4GAgYB+f35/gH+AgH+Af35/fn+AgH9+f35/gH+AgICBgH5/foCBgIB/gH+Af4CAgH+Af4CAgIB/gH+Af4CAgIB/gH+Af4B/gH+Af4B/f35/gYCBgH+Af4B/gH+Af4B/gH+AgIB/gH9/gH+Af4B/gH+AgH+AgH+AgH+Af4B/gH+Af4B/fn9+gIGBgH5/fn+Af4B/gH+Af4B/gICAf4B/gIB/gH+Af4B/gH+Af4B/gH+Af4B/gH+Af4B/gICAf4B/gH+Af4B/gH+Af4B/gIGBgH+Af4B/gICAgIGAf4B/gH9/gIGAgYB/gH+Af4B/gH+Af4B/gH+Af4CAf4B/gH+AgH+AgH+Af4B/gH+AgIB/gH+AgH+Af4CAf4CAf4B/gICAf4B/gH9/gH+AgH+Af4B/gH+Af3+Af4CAgH+Af4B/gH+Af4B/gH+Af4B/gH+AgH+Af4B/gICAgH+Af4CAf4B/gH+Af4B/gIB/gH+Af4CAgH+Af4B/gIB/gH+AgH+Af4B/" type="audio/wav">
    </audio>
    
    <audio id="player-hit-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRkYmAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0Yf0kAACAf39+fHp5eHp0cm1faGpramdhUllgWWFea2xPYXNsVkc6T2VmXHWdkqe2m4F+eXyBc2RpaFxtb1JRVV6GjpGhn626tsHP09bTzraSrr2noJOAh5+DfIeLq6+VjJKHhJCjtL7Oysazt77QzrS/zOHi5/Hw7+jm5eHg0tre18zV4Nbespa/way4raKmo6KbpbSknoSdro+PiJmgr77AutHl9Pjx6NTZz9Xj6OHQv8zQzt7Krcza6P/5/+ra2ODMx9fU3tjX5/Dv7tTRzr290dzn7+nbu7zX59POy7ugq8CwrK6kmY6MiZuSjquamoyXmpGjkIGju8PHyNbYvrfDwczO2uDg4fHz8djOxsLPxMHO4+LYqpSVrrOknqu1tMCZl56dqbnG3OTj4c3Ku6+nq720npKXp67Aw8O/0tvR2eX6+PDx9e/m3uDQyNDQ2OHh3Nja0Mzg0MfR4t/X4NfOysGXiJeLa219fX50eWxUV11VYl9cdWxWZ21ogHl8cXZ1bHV2dGqAfICTnqu1t6Gntr3Cs7ayqra/ycm/uLu7wsnPzM/Wz9G9trixsqyln6SgmpyinKrBvrWokHh4f3Z/m5qRipCur52hoKGonYuOlJWRj6Cin6Wptr7AwLyvpaawtauql42Ll6GTj4iBipiNkZ2fs7yyqqSottDNw8fH3Ozv9Pjt4+fo5t7Vz8HIv7e4uLunoay0r6Sao6+oo6iamJycnZifoa20tcnHw9LVwLO2p6ibfWBUbHJhWVQ9OkVHPz1HQDlEOycoKzI1MDE1PEBGUlFPSj5IU09WXVlbUUlKSEtMSTs5PUBGQjUmIis9PUJNVWJ0goZ+fIB4cXJ7d3FpaGNdW2ttYWdzhYiHeHd2eH17dn2HjpiWl4d9gYuNhYF9eXZtYFtlbG9tcHNva2ZjXl9gYWBodXyBhYSEhndwaVxYXV9janR6eoOHjo6JhYyZrbSvqqmxqKmim56ZlJCIhoaAf3pze4KAgICDfoGKjY2GjZWano+FhYWKlJqcnJ+go56Vk5OVmZyYnp+fm5WNj6CpqaShpa2tsbi4ubeyr6efnJmdoqKfk5SYk5Cap7O8vL6+u7OwsK+xsrKsmo2GgX53bXR3bGZqc3Byd3Nram5rZmJeWVJJPzxGT1VZYGhmWVJZXFxdaWVja3J7foONmZWZoKCjqLKytLKspaCdm5ePhnpxYlRVW15gWlNRS0M6MzM4Q0pMSEFAQUBGT1JXV1BIRklMSEZCPTcxNTpIU1daZG94gIeIhYJ8fICEf3+Gh42Qjo+MgnpybGhlZ2lpZmJdXGJiX2BfX2BdVEpBQERHR0hNSlBYXWNrdH6Ll5qXlI+Oi4eGg35+f394c3FsbWtpbnFxc3h/goKIj5ihqLK6uLOsop6al5SUmJOPjIyQkJCUlZCNjIiDfHZ1dnh8foCBfnd3fH19eXNwcXNxdoGFiJCWm5qZnJeUlIyHg4KAfXp5e3t9gIWNk5eYlpGQj4iFgHlzb29tbXF4foSHhIOGiI2Rk5STkZKQjoiEg4aPmqatr6yoo52doZ+cnp6goKOlpaOflo+LhYKCgoB+fH14dHRzdXd1cnByc3BubW5vdHl8fn54dHFucHZ4dXJrZmhrb3V6goeLkJCSlJWVlpKNi4uQkpOYnqWprK6vsbO3ubezrqilp6+5wsjFwr25ubq6t7Kws7Wzs7Gsp6CXkY2Jg4J9eXp4eHp5c25rZmReV1JQUlNZXmFlamxub3R4eXl2cW1tcHR5eXx+fXx6dWxmY2BiYWBhZGhscnV0dHR3e3t/goOFhYF7dXNxcnd6fHx7dW9mXFFJQjw3NDQ2Oz5AQklPVFpjaGloaGxrbGxubnBxcW9wcGxvcnJzc3Jxc3d1d32EiIuLio+VmZmVko2Ff36Af3x7en2BgHx4cWlkYVpRTE1RWGBmamhkX11gYmNjXVhTUE9PUlZZXV5eX1hVVlZUUVFTVlpdX2ZoZGBgYWJkZGRlZWRlYmJhYF9dX2Jka3J2en2Di5WfqrK3vcLHyMfFwbmzsbKztLW0r6qsrrK1tLKuqqinop2ZlJCJgHp0b21ub3Bwb25rZmNiYmJhX15dXFtaWVhWVFBNSkQ9OTc4OTk7PDw9PTs7PT8/P0RJTVJYXWFla3F3d3RzcnBwbm1qaGtpZWNgXl9dW1hUT0xLRT9AREdHRkhMTU1PVFheZWlqampvc3V4f4eMkJKUl5uYko2IgX16eXZ1dnd5e3x7dnJvamVkZWRjYWJiZWlnZmdjX1lTTUhEQT8+Pj4/QkRHSUpKS0xLS0xQVlpdYGJgXltaXWBlaW10e4GChYmOk5WWmJmbnp6dm5mampeSjouJh4aGhIGAfnx3dXZ5eHp9goeLjo2QkI6Lh4SCgYB9eXZzcWxrZmFhYF9gZGlvc3d8fX5+e3h3d3Z0dXV0dnp6e3p5eHd1c3Bta2hnZ2htc3iBi5WbnqCgoaKgm5mYmJeVkIuJiYqJh4eFhIaHh4iGhIF9eXZ0cGxra21ucXJwcXJzdHNxcXBxcnR0dHV0c3Jua2xubm5vbWxtb3JzdHh7fYB+e3dzcG9tbGtscHV6fX59fHl3d3p9fX1/gYOFio6Tl5mbm5eVl5ianJ2io6SlpqakpKWnqKmpqqyvsrS3t7SysrS3ur2/wL+/wsTCv7u4t7Sztrm+w8fLz9HQ0NHPzs3Jx8bEwcG+u7i1tLKztLS0tbOxsa+tqaajoKCemJOPjImEgoCAgIB/f39/f35+e3p4eHp8fn9/f4B/fn1/goWFhIWJjJCUl5yhpquws7Kxr62qqKimpaSjo6Slp6mpqqqqqKakoJyWko+NjIqKjI2MiomLjY2MjZCTl5mZmpyeoKOmqqyur7KztLa4uby+vLq4t7a3t7m8vr/Av7u4tbKtqqikoJmUkI2KhX93cW5raWhpa21wcnJzdXd6gIaLkZeam5ycm56fn52cm5uYlZSSkZGSkY+Ni4mIhoSFh4iJiYmJiIiFhIODhYaGhoiLjI6QkJCQj42MjI2QkZGRj4yJhoJ+enl6fH5+fn19e3p7foCAgH98e3l2c3BubWtnY19cW1teYmdrbnF0d3l5eHd3eHyBhoqOk5WUkY+Lh4OCgYKEhoiKjZCTlZWXmJeVlJOTkpGPjYuJiYmJiYqMjZGVmp6fnp2dnJqXlJOTlJaYmZudnJqampqZl5aUko+Mh4SAfHp3dXV1dXZ4enx+f4KFiIuNkpaYmZiXlpeYmZmYl5WTkIuHhIB8enh2dXZ2dnNwbWxtcHFydXd4eHh2dXRzdHV4eXl5eHVzb2tnYl5bWVdWVldYWlxeX15eX2BiZGRiYWFhYGBiZWhrbG1vcXJxcHBwcG9ubm5vb3BvbmxqaGVgXFpYV1dXV1lcXFxcXFxcW1hVU1BOS0pJSkxNT1BSVFZYWVxdXl9hY2ZqbW9vcHFycnFwcHJ1eHp6e3t8fX1+f4CAgIGChYeJi42NjYuIhYOBfnp4eX2BhIaHh4aFhoeIiIiJioyOkJKWmpycnZ6dnp+hoaGhoaGipaipqqqqqqurrKysqqinpqSioJyZlpORj46Mi4qKiomJioqKiYiGgn98eXZ1dXV2eHh4d3Z3eXt7e3p4dXNycnN0dHR0dHNzc3Jva2dlZGNiYmNjY2RmZ2hoamtsbGxtbW5ta2ppaWtucXR2d3l5ent5eHZ1c3Jxc3R3eXl6ent9gYWJjI6RlZmdoqaqrrG1uLm6uru8vr6+vLq4trWzsKynop+cmpeVlJKSkZCPi4iEgX57eHVzcnJzdHV2eXt9f4OFhoiJiYqKiomFgn57eHRycG9wcG9tbGtqa2xsbGxub25tbnFzdHZ5fICEh4qNjpGSkpKTlJWXmJiZmpucnp6dm5mXlpSTkY+MioiHhoWDgYCAgH9+fn+AgYKDgoOEhoeJiouNj5KVmqClqq6wsrS2tre4uLi3t7WzsrCwr6+vraupqKiqq6yrqaelo6GfnJmYmJaVlJKRkI+OjoyLiIaDf3t2c3FvbW1sa2pqaWdlZWVlZGNjY2NiYmFgX19fX19gYGBgX15dXFxcW1tbXV9iZGZnaGhpampsbm9xcnN1dnh5e3x+f4CAf359e3h2dXV0cnBubGppaGhqbG5wcnJycnJycnFvbW1vcXJzdXZ3eHl5enx/gYGDhIWFhISCgX99e3t8fH19fX6AgYKCgoKDg4OEhIOEhYaIi42PkZKTk5WXmZqam5ubm5mWk5GQj4+QkJCQkJCQkZKTlJWXmJmYlpSTkpCOi4iFg4CAgIKEhoeJjJCUmJyeoaSmp6inp6ampKOioKChoKChoaKioqKio6OioqGfnJqZl5aVlpaWlpWVlZWUkpGRkpSWmZudnp+fn5+goKCfnZyamZmampmYl5eXlpaWl5eXlpWUk5GPjYyLi4qKiYiIiIaFg4B+e3p4eHh5enp5eHh5e31/gYKEhIODhIWHiImKi4yNjY2Ojo2LiomHhoWFhIWGh4iKi42OkJGSk5OTlJSVlZSUlZWWlZORj4yJh4aDgYB9enl4d3d3eHd3d3d3eHh3dnV1dnd5e35/gH9/f39+fn5+fXx8e3x8e3t6eXl4d3Z1dXZ2dnd4eXp7fHx9fX5+fn6AgoWIi4+Tlpmdn6CgoJ+fnpybmZiYl5aVlZSUk5OSkpKQjoyIhH96dnJua2lnZmZoaWttb3FzdHZ3eXt9f4GEiIyQlZuhpqqtr7CxsbGwr6+vrq2rqqmnpqShnpycnJycnJ2foKCfnp2cmpmXl5aWlZWVlZaYmJmZmJeXlZSTk5KRkZOVl5qcnp+fn5+en6ChoaGioqKioaGhoKCenJmXlZSSkI6LiIWCgH17eHVzcW9tamloZ2ZlZWRjYmFgYF9fYGBgYWFiYmNiYF9dXFpZWFZUUlBOTk1NTU5QUFBQUFBSVFdaXWBjZmhqbG5wcnR2eHl5eXl5eXl5ent8fX+Bg4SFhoaGhYSCf317eHRwbWlnY2BeW1lXVlZWV1laXF9hY2Vnamxtbm9vcXFxcXBvbm1sa2lnZWRjZGVmaGpucXR2eHp7fX6AgYKEhYWFhYWFhYWFhYWFhYSDgoF/fnx6eXh3d3Z1c3JzcnBvbWxrbG1ubm9vcXJzc3NycW9tamloaGhnZmVkZGRjY2VmZ2lqbG5wc3Z4en2AgoaIi42Qk5WWl5iYl5aVlZaWmJqcnZ6foKGioqKioqKhoqGhoKCgn6CgoaKjpKSmpqalpKOioaGipKaoqaqqqaioqKiopqWjo6KioJ6dnJubnJydnp6dnJqamZiWk5GOi4iFg4GAfn59fX19fn+Bg4SFhoaHh4eHh4iIiYqLjIyMi4qJiIaFg4KBgYKDg4SEhISDgoKCgH99fHt6eXd1c3Fwbm5tbm9vcHFydHV1dnd3d3d3d3Z1c3JycXFyc3R1dnd4eHl4eHh4eHh4d3d4eXl6e3t6eXh2dXNycnJzc3R1d3l7fX5/gIKDhYeJiouLjY2NjIuJiIeGhYWEg4KBgH58e3p5eHh3d3VzcXBwcHBwcHBwcXFwcHBxcnN0dHV2eHh4eXp7e3x+f3+AgYKDhYaHh4eGhYOBf317eXh3d3d3eXp7fX5/gIB/f359e3t8fX5/gIKDg4SEhISEg4KAf359fHt6eXh4d3d2dXV1dXV0c3Nzc3Jzc3R1dnh5enp7enp7fH1+f4CCg4WGh4iIiYuNj5CSlJWWlpaWlZSTk5OSkpKSkpKSk5OSkpGQj46NjIyLiomJiIaEgoF/f35+f3+AgYKDhIeJi4yOj5CRkpOUlpeYmZubm5uamJeVlJKRkJCPj4+PkJGSk5SVlpeYmJiXlZORkI+NjIqJh4aFhIOBf359fHt6ent7fH19fX5+fn5+fn5+fn5+fnx6d3RxbmxqampqamprbG1tb3Bxc3R1dnZ1dXV0dHV1dXV2d3h5e31+fXx7e3p6eXh4eXl6e3x8fHt7e3x9fn5+fn+AgYGCg4OEhISEhISFhYaHioyNjY2NjIuLjIyMjIyLiomIh4aFhIODg4KBgICAgICBgYGBgH9+fHp4d3V0c3FxcXBvb29vcHBwcHBwcHBvb29vb29wcXJzc3V2d3h4eXt8fn+AgIGBgYB/fXt5d3V0dHR0dHR0dHNycnJzdHV2d3l6enp6ent7fH19fn5/gIKDhIWGh4eJiouMjpGTlZaXl5iYmZiYmJiYmJiYmJiYmZmZmpqampqZmZiYmJmZmZmYl5aVk5KSkpKSk5SUlJOTkpGRkJCPj4+PjoyLiYiHhoaFg4KBgICAf35+fn18enh3dnV1dHNycW9ubWxsbW1ub3Bxc3V4en1/gIOFiIqMjo+QkZKTlJSUlJWVlZSTkZCOjYuJh4SCgH58enh2dXNzcnJxcG5ta2ppaWloZ2dmZWVkZGVmZmZlZWVlZWZmZ2doaWpsbGxra2poZ2ZlZGRjYmJiY2NkZGRkZWVmZ2hpamxtbW9wcnR2dnd4eXp7fH1+f4CCg4SFhoeIiYqKi4uLiomIh4aGhoaGhoaFhYSDgoGBgYGBgoODhIWHiIiJiYqKioqKiouLjIyMjI2MjIuKiomJiIeHh4aGhoWFhIOBgIB/f39/gIGBg4SFhYWFhISDg4KBf358enl3dXRycXBxcXJ0dHV1dnd4eHl6e3t7enl5eXl6e3x+f4CCgoODg4SEg4OCgoKCgYGAf3+AgICAgH9+fXx6eXd2dXRzc3NzdHV1dnZ2d3h6e319fX18fHt6eXh3dnVzcnBvb29wcHBxcnJzdHV2d3h4d3Z2dnd4eHl6ent7fHx8fHt7enp5eXh4eHh5eXl5eXp6ent8fn+AgICAf359fHt7enp6ent9foCBgoSEhYWGhYaGhoaFhIOCgYB/fn18e3p4d3Z1dHNxcG9vb3Bxc3Z4e32AgoOFhoeIiYqLjY6PkJGSk5SUlJSVlZaWl5iYmZiYmJiXl5eXl5eXlpWUk5GQj42Mi4mIhoaFhISEhIWFhoeHiImKi4yNjo2NjIuKiYmJiYmLjI2Njo+QkJCRkZGQkJCQkI+OjoyLiomIh4aGhYWFhIOCgH9+fn5+fXx8fHx8fHx8fHx8e3p6enp6e3x9fn5+fX18fHt7e3t7e3p6ent8fX+AgYGCgoKCg4ODhIWGh4eIiIiJiYmJioqLi4yMjIyMjY2NjIyLi4qKiYmKiouMjIyMi4uKiYeGhYSDgoB+fXt6eHd1dHJycXBwb25ubW5vcHFyc3R2eHl7fX5/gIGCg4ODg4SEhISEgoKBgIB/f39+fX18fHx8fHt6eXh3dnRycG9tbGtqaWlpamtsbW9vb29vcHBwcHBxcnN0dXd4eHl5eXh4eHl5ent8fH19fn5+f39/gICAgYGAgH9/f39+fXx5dnNxbmtqaWlpaWhpaGhoaGhoaGhqa21vcXN0dXZ3eXp8fX5/gIKDg4ODg4OCgYGBgYGCg4ODgoKDg4SEhYWGhoaGhoaGhYWFhoaHiIiJiYqKi4uMjI2Njo+QkZGSk5SVlpaWlpaXl5eXlpaVlZWWlpaXlpeWl5eYmZqam5ucnJycnJuamJeVlJKQjoyJh4SCgH58enl5eXl5eXl5eXl6ent7e3x9fXx7e3l4eHd3dnZ1dXRzc3JycnJycnNzdHZ3eHl6ent7fHx8fX5/gICAgICAgH9+fX18fHt7fHx8fHt7e3t8fH18fHt6eXh3d3Z1dHRzc3Nzc3Jzc3R1dnZ3d3h5enx9f4CBg4ODhISFhYaHh4eIiYmKiouLjIyNjo+QkZKTk5KRkI+OjY2MjIuLioqJiYmIiIeHh4eHhoaFhYWFhYSDgoGAfn17eXh2dXRzc3NzdHR0dHR1dXV1dXZ3eHh5ent8fHx9fX59fX19fHx8e3p5eXl4eHZ1dHNycXBvbm5tbGtra2tra2tra2tra2tsbm9xcnN0dXZ3d3d3eHh5eXl5eXl5eXl5eXp6enl4d3Z2dnd3eHh5enp7fHx8fH1+f3+AgICAgYGBgoOEhYaHh4iIiYmJiYqLi4yNjo+QkZGSk5OSkpGQj46OjY2MjIyMi4qKioqLi4uLi4qKioqKioqLjI2Ojo6Ojo6Ojo2NjY6Ojo6Ojo6Ojo2NjIyMjIuKiYmIh4aGhoaHh4aGhYSDg4KBgIB/f39/fn5+fn59fHt7ent7e3t8fn+AgYKCgYGCgoODhIWFhIOCgX9/fn19fHx7e3t6eXh4d3d3d3d3d3Z2dnd3eHh4eHl5eXl5enp7e3t7e3t8fHx8fXx8fHx8fHx7e3t7fH5/gIGCg4ODg4ODgoKDg4SEhISEhISDgoGBgH9+fX19fX19fn5+fn5+fn19fHt6enp4eHh4eHh5eXl5eXl5enp7e3t8fHt7e3p6enl4d3Z1dXRzc3Nzc3NzcnJycnFxcG9vb25ubW1sbGtramppaWloaGlpaWprbG1ucHFydHZ4ent9f4CAgYKEhYaHh4iJiYqKi4uMjI2Njo+PkJGRkZCQkI+Pj4+Pj4+Pj4+Pj5CQkJCPj4+Pj4+Pj4+QkJCQj5CQkJGRkZGRkZCPjo2Mi4qIh4aFhIODgoGBgH9/fn19fHx9fX1+fn5+fn59fX18fHx8fHx8e3p6eXl4eHd2dnV1dHNzcnFwcG9vcHBxcnJzdHV2dnd4eHl5enp7fHx9fX5+fn5+fn5+fn9/gICAgIB/f39/f39/f39/f359fHt6eXl5eHh4eHh5eXl5eXl5eHd2dXRzc3JycnJycnJycnJyc3R1dnd4eXp7e3x8fHt7enp5eHh4eHh4eHl6ent8fHx7e3p6eXh4d3d3d3d4eHh4eHh3d3d3eHh4eHh5eXl5eXl5eXl6enp6ent8fX5/gIGCg4SFhYaGh4eIiImJioqKioqKioqLi4uKioqKiYmJiIiHh4aGhYSEg4OCgoKBgYGBgYGBgYGAgH9/f3+AgICBgYCAgIGBgYGBgoODg4SEhISEhISFhYaGhoaHh4eHh4eHh4eGhoaGhoaGhYWEg4OCgoKCgoGBgIB/f359fXx7e3t6enp6enp6enp6enp6enp6enp7e3t7e3t7e3t7e3t8fH19fX19fn5+f39/gICAgICBgYGBgYGBgYGBgYGBgYGBgICAgH9+fn19fHt6enl5eHh4d3d3d3d3dnZ2dXV1dXV1dXV1dXZ3d3d4eHl5eXl5enp7e3t7e3t8fHx7e3t7enp6eXl4d3d3d3d3d3d3d3d4eHh5eXp6ent7e3t8fHx8fHt7e3t7e3t7e3t7e3t7e3t7e3p6enp6enp6enp6ent7fHx8fX19fn5/f39/f39/fn19fHx8fHt7e3t7fHx8fHt7e3t8fHx8fHx8fHx8fHx8fHx8fH19fX19fX19fX19fn5+fn59fX19fX19fHx8fHx8e3t7e3t7e3t7e3t7e3t7e3t7fHx8fH19fX5+f4CAgIGBgoKCgoKCgoKDg4ODg4ODg4KCgoGBgYGCgoKCgoKCgoKCgoOCgoKCgoKCgoKCgoKCgYGAgH9/f39/f39/f39/f39/f35+fn5+fn5+fn59fX5+fn9/f39/f39/fn5+fn5+fX19fX19fXx8fH19fHx8fHx8fHx8fH19fX1+fn5+fn5+fX19fX19fX5+fn9/f4CAgYGBgoKCgoKDg4ODhISEhISEhISEhISEhYWFhYWFhYWFhYWFhYWEhISEhISEhISEhISEhISEg4OCgoGBgYB/f35+fn5/f39/gICAgICBgYGBgoKCgoKCgoKCgoKCgoKBgYGAgICAgICAgICAgYGBgYKCgoKCgoKCgoKCgoGBgYGBgYCAgICAgICAgICAgICAgICAf39+fn5+fX19fXx8fHx8fHx8fH19fX1+fn5+f39/f4CAgICBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgICAf39/f39/f39/f35+fn59fXx8fHx8e3t7e3x8fHx8fHx8fHx8fHx8fH19fX19fX5+fn5+fn5/f39/gICAgIGBgYGBgYGBgYGBgICAgICAgICAgH9/f39/fn5+fn59fX19fX19fX19fX19fn5+fn9/f4CAgICAgIGBgYKCgoODg4OEhISEhISEg4ODg4ODg4ODg4KCgoKCgoKCg4KCgoKCgoKCgoKBgYGBgYGBgYGBgYGAgICAgICAgICAf3+AgICAgICAgICAgICAf39/f39/f39/fn5+fn19fX19fX19fX19fn5+fn9/f39/f39/f39/f39/f39/f39/gICAgICAgIGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGAgICAgH9/f39/f39/f39/f39/fn5+fn19fX19fXx8fHx8fHx8fX19fX19fX19fX19fX19fX19fX19fX5+fn9/f39/f39/f39/f3+AgICAgICAgICAgICAgICAgICAgICAgYGBgYGBgYGBgYKCgoKCgoKCgoKCgoGBgYGBgYGBgYGBgYGBgYGBgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIB/f39/f39/f39/f39/f39/f39/f39/f39/f39+fn5+fn5+fn5+f39+f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgH9/f39/f39/f39/f39/f39/f39/f39/f39/f39/fn5+fn5+fn5+fn5+fn5+fn5+f39/f39/f39/f39/f39/f39/f39/f39/f4CAgICAgICAgICAf39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f4CAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgH9/f39/f39/f39/f39/f39/f39/f4CAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgH9/f39/f39/f39/f39/f35+fn5+fn5+fn5+fn5+fn5+fn5+fn5+fn5/f39/f39/f39/f39/f39/f39/f39/gICAgICAgICAgICAgICAgICAgICAgIB/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f4CAgICAgICAgICAf39/f39/f39/f39/gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIB/f3+Af4CAgICAgICAgICAgICAgICAgICAgICAgICAgH9/f39/f39/f39/gICAgICAgICAgIB/f39/f39/f39/f39/f39/f39/f39/f3+Af39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f4CAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgH9/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f4CAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAf4B/gH9/f39/f39/f39/f4CAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIB/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f4CAgICAgICAgIB/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f4CAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAf39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAf39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f3+Af4B/gH+AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIB/f39/f3+Af4B/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f4CAgICAgH+Af4CAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIB/gICAgH9/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/gH+Af4CAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIB/gICAgICAgICAgICAgICAgICAf4B/gH9/f39/f39/f39/f39/f39/f3+Af39/f4B/f39/f3+Af4B/gH+Af4B/gH+Af4B/f39/f3+Af4B/gH+Af3+AAExJU1R+AAAASU5GT0lOQU0WAAAAU3ludGhldGljIGV4cGxvc2lvbiAxAElQUkQYAAAAU3ludGhldGljIHNvdW5kIGVmZmVjdHMASUFSVBAAAABJd2FuIEdhYm92aXRjaAAASUNSRAYAAAAyMDA5AABJQ09QDgAAAHB1YmxpYyBkb21haW4AaWQzIJYAAABJRDMDAAAAAAEMVElUMgAAABYAAABTeW50aGV0aWMgZXhwbG9zaW9uIDFURFJDAAAABQAAADIwMDlUQUxCAAAAGAAAAFN5bnRoZXRpYyBzb3VuZCBlZmZlY3RzVFBFMQAAAA8AAABJd2FuIEdhYm92aXRjaFRYWFgAAAAYAAAAQ29weXJpZ2h0AHB1YmxpYyBkb21haW4=" type="audio/wav">
    </audio>
    
    <audio id="game-over-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRhIPAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0Ye0OAACAiYyMioN+bmJTTThWibW/n5iFemxfVUNklW6VvZ2VgXllYkl0mX1ybq2ji4RwbFN+oYZ6cFuGqIp/dGCCrY2GdGpcWZuOgGyFt5mPf3NmW0tmnXaGu6yXjnxzY1lOQHaNtsOinomAcGVaTEc1oN6yrpmPfnVmXU9HO4DNwqyhkIV2bV1XRlCPfLS/oZqJfnFkXEpfloFwmLyclYV7bWNUYKCFf2xxraOPh3duYVuamIR7b196ro6Kd3Rcf6yRiXtvZ1V5pYiAdWWUspKQfXdnYVBkn4OAZ5W2mJKBeWljUHGhgn9sc7Kgk4V8bGlScaGLfnhjfrGYjoJ2bGFampqGfnJmaquajYN2b15pppiHgnBvV4CpkIh9cWlgo6CPhntvaFlqqI+KendiebCdkYl6dWVkT3Wji4R5bm+xp5iPhHtxaF9WUpGXgIBsgLqnnZOIf3ZsZVpXR3ecf4JtqryloJOLgXhwZmFVVUJjloZ2lsivqZ6UjIJ7cWthXFNORkaNhYnNu7Kon5WNhHx0bWVgV1NJSTlckL/SuLinpJeSh4N3dGlmXFpPT0NGNFnhzcK7sKmfmJCJgXt0bWhhXFVRSkdAQoWPyc26uauonJiOioF8dXBpZV5bVFJJSj+CkYN7lNC4t6unnpiRi4V/eXRvamRhW1hRUUdXmJGHhnt9bJXFsa6moZqUj4mEf3p1cGxnZGJbUUpASbXWu7eooJWLgndyYImzlpWGg3VpWk8/Sa/Iq6KQhXVqWlBATKzIrKORhXZqW1FBTKTIr6OThnhrXlJCS5jFtKOXh3ptX1VDS4i/uqaZjHxyYFpFSXetwKuckYB2ZlxOQm+TvrWglod5b11ZP2CFn8SlnY2BdGdbT0WDgK68npqHfm9jWUdbkHe3s5+VhnttYVdGcJFws7OflId6bmFXSXiSbJ25oJaJfHJjXEl3lHR7sa2Wkn56ZWRLaJWDcYC2opWLfHRkX02MkH5xdrOglYh+cWhZWpaQe3lkn6qVjIB0a15alZWAfGtrpqKPiHtwaFd/pIaFc25fm6SNiXlyZl2Ro4aIcnRccKSYh4NycFuOp5CKfXVqYF+glYl/dmpppqOQjXx5aWdTbaGLhXlyZ6Srl5KFfnNqYVhTj5WAgG15s6malYiCdm9mXVdKf5d9f2yluaKfkoyBenBoYVdUQ3eSf3Waw6inmpSKgnpxa2FdUU8/ZJR0nMiyraObk4qEenVqZ1taTE09SoCZzL20raOdlI2FfndvamFdVFBHRTlHydC6u62rnpuQjIN+dnBqY19WU0pJPUN5o83At7KopJuXjomCfHZwa2NgWFZMTT9RjId4jMa7sq6loZmVjYmBfnZzbGhiXlhUT0pNj46Dgnp2dbm3ramjnZiSjYiDfnl1b2xmY1xcU1VJjJeewKummpKIgHVuZJ+plJKEf3RtZFpVR4rFpaCNhHNpWlBAZbm+qp6Qg3ZpXVBCYK/ArJ+ShHhrXlJDWaHBr6CVhnttYFZEVY+8taOYi3xzYVxFUX6svaebkIB3Zl5OR3SSvLGelYd6b19aQWaEn8CinYyCdWhdUEqEf6+3nZmHfnBkW0hgjni5rp6ThntvYllIdI1yta2ekod6b2JYS32NbaO0nZWIfHFkW0x8kXGDtKaWj354ZmRLcJN/cI22mpaGfXBmW1WSiH1sjLOYlIR8bmdWZpyDf212r5yThn5va1Zsm4p9eWOLrJSOgXdtYl2YlIV7c2KCq5CNf3ZtXnGmjIl6dGZlnZyJhnVzX3SmlIqBdm5iYZuYh4N0cGGYpo+OfXpqaVR5oImFeHJlnamUkIR8dGlkU2mcioB7a36yoZiRhYBzb2FgTGuZg4ByeLSpnpeNhnt2amdZWUZ5kX93gLyrpJuTi4N7c2tkXFVNSICMcpjBrKmemY+JgHpxa2NcVU5IQ4R+qsetsKGfk5CGgXhya2ReVlFJRjplwcW3s6qlnJePiYF7dW5oYlxVUElFO1S2yrm3ramgnJOPh4J7dm9rZF9YVE1KP1qSdJnGtbKrpZ+Zk46Ig3x4cW1mZFtaUVFEV4+HfX9vlsCuraWhm5aRi4eBfXdzbmllYFxWVUtfmoqIgn55dHFrp7Wlpp6blnhqY1xPgJeAf3JtY11TTUJns8e2sKagg2liVEdcpL6tn5WHfG5jV0hWlr2xoZeJfXJkW0lRhre2pJmNf3ZmX0xOeKm7qJuSgnpqYVNHbpK4sJ6WiHxyYl1FYoOivKKbjoJ3aWBSTH+Fs7Kdl4h9cmRdSGaIhL6mnpCGeW9hWUl+goi+oZ6MhnZuYFdPjHyEuqObjYR3bWJVVo9+eK+rmZKDe21mVleLh2+StJyWiH9zaF9Rg455cp2wlJSAfmtpVGeXgntsnquUkYF7bGdUeZp9gGeKrZaRg3xuaVZ+m4N+c2ido5GKf3RtXW2fi4R4cGWZoo2KfHRrXoWihoh0dV98pZGJgHVvXoqjjIh9dG1de6SKiXp2Z3Gnl4+FfXRrYl2Ykod+eGh6rJqTioB5b2heWI6UgX9zbJuulZeGhXZ0ZmRVXJKMfnxsnLKbnI2LfXtta11dS2yUf31yrbChnZONhH12bmdfWFFLf4x0irutpp+XkIiBenNsZV5XUUhOi3mmwqutn52Sj4SBd3NqZV1YUUxDRoS+vrKvpaGYlIyGf3pzbWdgXFNRRkc4jtC1uKyqoJ2UkImEfXlybWdiXFdRTEVLinmgxa+xpqWcmZGOh4N8eHJtaGNdWlNRRl6SfoF0grqxq6ehnJeSjYiEfnp1cWtoYl9aVlFQjI+Fg354d2yCt6enoJ2Yk4+Kh4J+enV2fHBqYlpTSU2Gub6uqqCZkYiCd3RlkqyjnI6Dd2thVElpoLipm5OEe25jWUlfkLSwnZaIfXNkX0pXgKi2opiOgHhoYlFOdZO2qpuThXtwYl1HaYOit56Zi4B2aWFRUoKEs6yblIZ8cWReSWuGh7uhnI2Fd29hWkyCfoy6nZuKhHVuYFdUjniKtp+Zi4N2bWJVW5B5frCll4+CemxmVl2NgnGar5eUhX5xaV1Wh4t2d6ankpF+fGlpUnOTgHZ0qKGSjH54amVWhpJ8e2mfo5OLgXduZFuKlX1+aXuol4+EfHBrWYOZhX92Z3qnkoyCeHBlZZqShX50a2ifl4qFeHRkbZ6Uh4N0c2Byn5GGgXRwY5iejYl9d2xmXpaTh394bW6jnY+Lf3tval1hlo6DfHVqmKmTlIWDdXNlZFJ3l4J/dm+jqZiVioV8dW1mX1VclIKBcYe0op2VjYd+eW9rYVxTUYWJeHyusKCgk5CGgnlzbGVfV1NHcYx0q7eopZyXj4mCe3ZuamFeU1JFUH2dwa+tpJ+YkouGf3pzbmdiW1ZPS0NGuMOvsqalm5iQjIWAenRvaWVeWlNPSUR0jLi6rK2ioZiWjoqEf3p1cGpmYFxXUk5Jf4d7eKa7p6ufoJeVjYuEgXt3cm5pZWBdV1VLcZV/hXh8bYm2p6WgnJeTjoqGgn16dXJtamRiXFtTX5aNiYaBfpGUhYR1d2OHppWQiYB7cG1hYFBdjYR4iIx7dGVfTF2Fq7Kel4t/d2ljUVN4nbWkmZGDe25lWkxui66um5WIfXVmYkxggZi2oZmOg3luY1lNe4OosJqWiH90aGJPYIeCtaSbkIZ6cmVfTXiEh7idm4uFd3BjXFGIfIq2nJqKhHZvY1lYjnmEsqCXjIN5bmVYXY5+d6aolZGDfW9pW1yJh3GLrpqTiH92amRUgI17cpWtkpOCf29rW2WUgn1tlKmSkIJ8b2padJl+gGuBqZWQhH5wbVt3mIV+d2iUoo+KgHdwY2iZjIN6c2aRoYyKfXZuYX2ghoh3dmR5oZCJgXZyYoKgi4h+dXBhfaCJiHt3am+ilY6FfnRuY2aajYd8eWp7ppaPiH96b2teZpaMgn1zb5+kkpKEgnZ0ZmZUdpWCf3ZzpaWYlIqFfHduaGBaWZCEgXOGsaGclI6HgHlybGVeWU57jHp6p7Gfn5SRiIN7dm9oY1tXTF2OdZu5pqacmJCLhH94c2xnYFtUUEZskLe0qaeem5KPh4R7eXBuZGNYWUxROnvMrrKnpZ2Zk46IhH15c29oZV1cUlNFWYKPvq+spqGcl5KNiIN+enVwa2dhXlhWTlSJgn13pbalqJ6elZSNi4SBfHhzcGtnYl9aWE5zlICFeXxxe62qoaCamJKPioeDf3t3dG9tZ2ZgX1hZiZWFi32Mm5OJhnt3bmycnZCNhH54b2tgYE50jYKZjoJ6bWZaUHONrqmZk4Z9dGdiTmWCnrKdl4yBeWxlWFR8ia6omJKGfXRnY05rg5O1nJmLg3hvZFxSgX+irpiWh4B1a2NVYYt6rqWZkIZ8dGhiUnOJebGhmo2GenNnYFN+hnesopiOhXtzaGBWgohyn6iXkYZ+dGpiV3+Mcoirm5KLf3lraFZ2j3xzlKqSkoJ/cG1eY4+Fe3GZpZCQgH1ubFp1lX5/a5KlkY6CfHBrXH2Wf4BueaSWj4R/cnBeeZeGf3lqgaOQjIJ6cmlllZCFfnZrdaKQi4F5c2dwnY6Hf3ZxY4qciYd7d2ttnJSLg3xzbmGEm4aHeHhnhKOPjYJ9dG5lZJWOhn15a4Smk5GHgXlza2Vch5KBgHVxmqWSlIaEeXZsaGBaho59f26Tq5iYjYqAfXNvZmJYXY6Df3OZr5uckY6FgXh1bGlfXlBojXx7qK2fnpSSiYV9enFuZWNYWklwhYW4qaafmpSOiYJ+d3NsaGJeV1VMW5u3q6ehnJeSjYiDfnp1cWxoY19aV1JVnbWlpp6dlZSNi4WDfXt1c25sZ2VfXldliXmZqp2emJaRj4qIhIF9e3d1cW9ramZlXnCKfoF5gZ+al5SRj4yJh4SCf316eHZ0cXBta2lphoaCgX98e3d+l5GQjoyKiIaEg4F/fnx7eHh1dXJxbG5/iZeSj42Jh4SCf316d4iLhoWCf314d3F0f4WPioeEgX57eHZyfIGJjIaFgoB9e3l1d4CBioeFg4F/fXt6d32Ag4mEhIGAfn18enqAf4OFgoKAgH5+fXx9gX+DgoGBgH9/f35+f4B/gYCAgIB/gAA=" type="audio/wav">
    </audio>

    <!-- Silver enemy sound (looping) -->
    <audio id="silver-enemy-sound" preload="auto" loop>
        <source src="data:audio/wav;base64,UklGRq4TAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YYoTAAB/gH+Af4B/f39/f39+fn58enl1c3Fxa2VkZGRgXF1hYGdgY2xvb292en59gYOKi46Ok5yeoaerrbW5uLW2t7SuqKKclpGJgn16dnR0cW90dXV1c3h4dXVwbm5pY1tkV1RVVlZRUFlfV2FdZW1ua3F6eXqAhIOJjJGUl5yhp6ytsbe6tra2tbCqpZ+akY2Hgnx4dnhzcXN1d3d3dnp4d3F0cWprZF9fXFlYVFpWWFxdXWBkZ21pb3Z5fX6BhouMjpKYnJ+kqKutsra1s7Ozsayln5uVkImCf314dXNzcnNzc3Rzd3N1cXFwbmlkZFxhXFdTVlZXWVtbXmNpbWpwcXt7fn+BiYqRkJOZnqClqqqvtLWzsrSzrqmmoZqUkYiDgHt3dnRycXJ0cnR0dXV1dHVxbW5jZmFgWlVXVVxWVFlgYGJiZ21vdHd3e4CDiIeLjZSam52kqqyvs7e1tre0saynoZuVjoiCf3p0c3RxcHB0d3R4eHh4dnl0b2loaGNZU1pWU1RPVFtbXGBmam1wdnp3f4OHhoeLjZSUl5qgpqiqrrOysbGyrailop2Tjo2HgX16eHd2dXR1dnZ3dnZ0dHVwb2hoZF5gWltUVFlaV1paXmhkaGxzdXd7fYKFhIiMjY+Tl5ufoqiqrbK2tbOzsrCrpaGalZGMhYB+e3h3dHNzc3VzcnRzdG9ubWhqYmNgWFtXWFdXVFpeXF9gZ2tsbXV4eHuAgYOHhoqOkpaYnKOoqauxtLS0tLSwrKijnpeSjIeDf3p4eHd0dXd2eHZ3eHZycnBvaGZlYl9ZXFddVFhZW2FdYmRta21xdXl2en6AgoOIio2RlpueoqSqr7OysbO1s66qpqGclpKMhYJ/fHh2dXR0dXRxc3dzcHBwbGtnY2FeXlhXWFlXVVdfX19kZGxtcXJ0fHl8gISFhIeOkZGUmp6hpamrr7KysrKxr6qopZ+ZlZKMiIR/fHt5dXR0dXFwcnBtbGxpamdlYl9kXl1cXFxeXl9fX2ZnaWVtcXJ1d3p8g4KEho2Nj5GWm5ygpqmqrrGzsrKvrqyppJ6ZlpGMh4R+fHt3c3NxcXBvcGtwa2xqZmlkYmBgYFxaWltfXFxfYWFmZmltbHF1e3x7gYWHiYuOj5KWmp2hpKeprbGvr7CwrquopqGcmJSPioaCfHt5dXFycW5tbG1ramhoaGVlYWJhYV1cXl9eW11eZWRiZ2lucXRzeHx/g4KDhoqLj5GTl52gpKeprbCysLGwsK6ppaGemZONiYaAfHl2dHFubW5rbWpra2prZ2lmZGNkYV9eXl5eXFxgYmNhZmpub3F1e31/g4WHiY2PkpKUmZufoaOmqq6vrrCxr6yppqKcl5ONiIR/end1cXBsbWtqbGtqZ2xqaWZkY2JiX11eXlpeXWJeYGRmaGpvcHR3f32ChYiIio+QkJKXmZ2gpKeor7OysrS2s6+sqaSfmZOOiYN9eXd1b2xtbmxqaG1sbGhoaGpkYmNgYV1eW11bXVtdYGFkZmpucnN3e3+AhYWIi42OjpOWmJqeo6Woq6+wr7GxsayopKCblpCKhoN/eXZ1c29ubW5ta2tsamtqZWZkZGFeXV5fXFtbX2BgYmRobG5wdHl9fXyBhoaGhoqOkJGTmJ6ioqSqsLCur7Kyr6qnpKGblI6KiIJ7eHl2cG1ub25pamlsaWhnZWdjYmFgXl5eXVxdXmBjYGZqbGxuc3h6eHyBh4aGi5CTk5WanqGkpamvsrGvsrOxrKilop2XkYyJhH96eHV0cHBwbm5sa2tra2pmZ2ZlYF9eX2FbWl1gYmBfY2xtaW1zd3p7en2EhoaHio+TlJecoKWnqayvsrGwsLCtqaOfnJeSi4aEgH14dnVzb25vbmxqaWtqaWRkZ2ViXWFfYF5bYF5iYWJkZWlsbm5wdnp7eXyCiImIjJObnZ6iqa6ysbKztrWxrammo52WkY6KhH98e3h0cnJxcW5wb25ta21raWZmZmNhXl5fXlxbXmJgYWFmbGtrbnV4eHp8goeJio+Vmp6ipamssbOysbCyr6qkoZ2ZlI6JhoN+enh3dXNyc3FvcHFua2psa2VkYmRhXV1bXFxdW11hZGVpa21xcnd5eXuAhIeHjJOYnKCnq6+zt7i5ubi1sKynoZqVj4mDf3t4dXRzcG9xcXBvb3BtbWtqaGZjYWFfW1pbXF1aW15jYmNmbHFxcnZ8f4CAhYqOkpWZoqmsr7W6vLu6uLaxrKadl5KMhH97eHRycXFwcXFyc3JzcHBva2hmY2BfXVlXV1hbWFdbYWVlZGlwdnRzd3+Fg4KGj5aYmqCor7O3ubu+vry4tK+qo5uUjYeBfHZzcnJwcG9wcnJycHJvb21oaGNgX1tYVVZYV1ZXW19hYWJpbW9vcnh9fX+DiY6SlZqjqq6wuL2/v769vLexqqOcl4+Gf3p2c25sbG1ub29wcXJxb29sa2hkYGBaWldXV1VZWl1cYmJoaW1vcnZ4fn+ChIuPlJedpq2wtLzAwsPCwb+5squknpaMhH55c29sampqa2xrbW9vbGttaWZlYl9dV1hZU1JUWVdYXV1lZ2hsbnR2eHl+homLkZuhp66zusDFxcXGxsO7tLCpoJaOhoB5c25ta2xpaWtubmxqa21oZWFlXl1YV1lWWFFUVl5aU19oaWVkbnl4c3mCio6OlaCrsLG3xczJxcvPy8K5tbCmmpCIg3x0bGtsbGhmaG5uZ2dlamRcWF5eUk9UVFVQT1pYW1tiX2RqZ2xqdHV2e4KHjJabpLC3vMTP0tLR0NHKvrexpZuRhX15cGllZ2dlZGhtamhpaWVjYFxYWVRQTlFSUVBTWVxhYWRqcW9udnp5e3+DjZCWoau0vMfQ09XZ19TNxby0p5qOg3tyaWJjYF9gZWZramtyaWtmZVtaWUxSTkdIUE5PUVFhZ1tfdXdxc3qChYKGj5igo6u5xczN093b09DNw7Wqn5aKe3NuaGFeYGFkaGptcXFubXBlXmFaTVJQRUdOR0dSTFhcWF5tcHN2fIuJjo+VoqmlrrvFysjN2tvOzs3Et6yfmot6cm5mX11cYGJmaWtxdXBwc2ljaFhQVFBEQkNFREBLTVNTXmNvcnR+hI2OkpelqK22vcnQ0NTZ2dPOyb+0qJyShnlvamNeXlxhYmZqcG5vd3BtaGZiWlJPSUVIQD5DSFBOVF9nbnF0f4iAi5STmZ+psLS6yM7Rz9fa08/Jwrmun5mNf3VwaWJgXWBjYWVnbWhna2JkXV5QUlJFT0NETkNOTVBbWGJqa3J5e4KJjJCVnqeqsrjIzs3S3NrT0MrEuaygm4uAdHFpYl5hX2RiZWxpampwX2RhW1tNUFhGTUZOVUZTVmBdYWtybnZ7e4GDiJCYoKuxvsnQ1dze3NnVzsa4rqSWiX11bGRhYFtfYGFpZGhqY2hjY1pVXE9QVEhMTFBUTlNUXV9daWdtcnR7f4aKk5+orLnH0NTa3+Pf2NXOwrKono6Bdm1oX1xbXV9gaWZrb25pbGpiZFhXWlVGTU5MSkhLTlxTWmZta3J4eoWKhJGboq6vv8fW19ni4NzWz8i7rKGVinpxaGJcWVhcXWBnaW1sbmttaGRXX1ZMUUhLQ09AU1NLX1lpZGx0cnl6fYmKiZiorLO/zNvY39/i4tTOxbisoY+DeHFlYV1aXV9gZWxrb29zcG1nZl5iUUtRSE9APk1MSVNPYWlobXV8f4WCiouRm6Coq7jKy8/Y2tvY0MvEuKqhl4Z7dWxiYl1fYGNmbG5qdnFwamlnX1lOUVFHPkRKSEhMTlpiZGhreX5+gHuLk46PlairsbfDztLV1dnWzsjAsqmfj4R6cGpmX11jZGVpbnBydHBwb2NiYlFWTURQQkhJPUtSUFZVXW1sc3Z2hoaHkoyWnqerrLzFy83Q1NXUysTBs6ehkoeAdG1qYmNnZGhrcnR1eHR3c2xlZl1TUk5MSUZASk1NTVNYYGljaXZ3en99iouPlp6prbXCy8zT1tbVzsjCuaqhmIt+dW9nZGBgYWdqbnV1e3t5dXdxaWJdXlBNS0VMRD1LTVFRU2BmbW50eYGChoiIjpSan6mtt8TIydDU0c3LxLqzpJqVhnh2bWZnZGZoa3Jwent2fXlydW1gX19SUFBER0dJR05LTVtjW2Jxb3l7foGJiYmQlpebqKitvcK/x87Iyce8t7OkmZaJe3dzaWloZ2txcHp5fIB7hHRxc2VlXVJQUElFSkZQRkxcWGJgY3N6dnt/gIWIh4iKjpabn6WsucHAxc3IyMa9t7GlmpWKfXh0amxqaGxxb3d7eHp+fXFzamhgWlNTTklOSE1PT1haW2Rpam92dHh6fH5/foaIi5KWoaestsHBxMrMxsW/t7GnmJKLfndzbWtsa21xeHZ4foB5fnZwc2hhXl1RUVhNSVNSUVdbWVxpbGVuc3F4e3N2gYGCiI2Snaeqr7zExMTMycHBvK+qoZaPiH13dnNwbnJyeHR6f3l+fHh1c21lX2ZcVVJVWVFYUVVbXV1eY19obW5naHN3d3R6g42PlZymsbO6wsXCyMnCvLeyrKKUjoyEeXZzcnFuc3R0eHt9d3l5d3dvZ2hkZF5TW1ZYVlNWWlhWXl5dXmRnamhwcHd7fYWIkJGcpauqsL7Bv77Bwb24sayon5aTjIV/fXl3dHR3c3V3enV4d3hxc3Joa2ZeY2JWVFtaTFdaU1RdV11oYGJudW91fISAhYyQlZefpKmts7e6vLu6u7ixrKmimpSOh4J8d3ZzbnFyb3J0dnZzd3ZxcXJpZmdhXVdbVFZWUVNYWVZfXmRnaXB3dXt+hIqMjZKanaKmqq63ubm7vry6trKtpqCakIiEfXh1cWxxbnFxdHZ4fHp6dnlycGtlZFtgVU5WU1FMUlZWXl1eZW5ycHV6gYOFiIiOlZeXn6aorbS5t7m+vra0squlnZaPiIF8dHNxb25ucXN2d3p6eXx8dXVqbmlhXlZZUVJTUk5WWFteYGRocm9xeHx8gISGiouTlpqip6yzu7y7wMG9ubOvqZ+ZkYmBfHVxb25rbXFydHd5fH54fXp1cXNmZGRZWlNTTVNRT09XWVtiYGhucW95eXt+hYeHjZGbnqOmrra8u7u9v7y0rqqkmpKOh395dnVycXByd3h4eX+BfH15fHVyb2ZkZVxXVFJVUVJSV1hgXGJqaW5wdnl7eoOHio2Pl52kp6mvt7u5uLu8uLGsqKKbk4uHg355dXV3dXN0eHx5dnp7enVxcm1rZV1fX1lRVVZYUlNaW19eYmZoa29wdXh8gIWJjZOZoaOmrbi6tre8vbawrKehmZKMh4J9eHd4dXN0dnl3d3h6end2cnRva2VlZF1bV1pXWFRYXlteXmdqa25yeXx/g4iLkpaaoairr7W6urm6urixq6aimZGMhoF8eHRzdHNycXZ4dHZ2enl2b3JxbGZfYV9fVVRYWVlVVl5iX2Bkam5vb3Z8gYSHjJSbnKCmrbKzs7W2t7OtpqShmI+KiIR+eXh3d3d2dXl8eXZ5enl0c25xbGZkXWFeWVZXWl1bWl1jZ2dla3N0dnZ8hIiHjJWcoaOnrre4tra5u7evqqijmZGLh4N+eHV1dndzc3Z4eHd3eXd3c3BvamhiX15aWVZWWVhYXGBhY2dobm9xdHd8f4GEjJOXnKOqrrK1tre3trSvq6egmpSOiIJ+e3h2dHR0dXZ4d3h6e3d4dnJybmpoY2FfW1lWXFhYWVxgYGNla2xvcXR6foCDiI+Ul52kqq2ytbi4t7a0sKqlnpiTjYaAfXp3dXN0dXZ2dnh6enl5eXZ2cW1vZ2RfYF1aWFZZWVpaXF9jZWlrbnN1eHp+gYaLkJSaoqaqr7W4uLi5t7StqaOdl5CJhIB9eXZ0dXV1dXd4eXt6eXp6d3Rxb2xnY2BcW1lXVFRYW1taXmRqaWttdHl7e32Eio+PlJykp6mutLe3tLSzsayln5qWjoaBf3x4dHN1dXRzdnh4d3h6eXh2c3JybWhkY2FdWFhaWVlXW19jY2ZqcHV2d3qAhIWGipGXmp2hqK+ztLS3ubizraqnopqTjYqEf3p3dnZ1c3R1d3h5eHp6eXZ2cnFtZ2RiYFtYVVdXVlZYXF9kZGZrcHN0d3l+gYOFio6Ump6ip66ztbW2t7ezraijnpiQioWAfHh0c3JzcnR0dnl6ent7e3l3c3BuaWZgXlpaVlNUVVlZW19kaGxscnZ5enyAhYeJj5San6OorrS4uLi4uLWvqaWfmJKLhYF+end1dXZ1dXd4eXt8fHp7e3d0cG1qZF5bWVdTUVJVVVZYXWNlaGtxdnh5fICGiImNk5idoaWqsLW2tbS1tK+oo56Zk42HgoB9eXZ2d3h3eHl7fHx7e3p5eHNxbWpnY11bWVdVVFZXWlteYmdpbW90eHt7fYGEh4qOkZedoqWprrK0tLKysK2oopyXk46Ig4B+fHp4eHl6e3t8fX59fHt5eHRvbGlkYF1aV1VVVVRVV1teYWRobG9zdXh8f4GEiIyRlJieo6err7Gzs7KwramkoJqUj4qGgn98enl5eXl6fX19fX5+fXp4d3Fva2hjX1xZV1VUVFVXW1xfY2hqb3J2en2Ag4eJjY+SlZufoqSorK+vrq6tq6einZmVkYyGg4B+fHp5eXl6e3p6fHx8enh3dnFx" type="audio/wav">
    </audio>

    <!-- Fart sound effect -->
<audio id="fart-sound" preload="auto">
    <source src="data:audio/wav;base64,UklGRioKAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQYKAACAgICAgICAgICAgICAgIB/f39/f39/f39/f4CAgICAgICAgICAgH+Af4CAgYGEi4mGiomEjIZ7hXxscGtYXlhRWFdYYXKCn6Wzu7m/sq2knpSOhX17dHFwbGhmY2VoaWtucHV2e36Bh4uPkZKSkZGQjYyGgn95d3Vvb25tcXFzdnZ7gYGGiomPj5CRjo6LiYeDgYB8fHl1c3Bvb29wcXJ1dnl6e31+f4KDhoeIiYqMjY2Nj4yNiomHh4ODhX58fXpybmpoaF5VW1lUUU9WaWxthKm1tM/h2szMwLCgkYZ6cWdiXVhYWVZXXF9jaXB2e4GGi5CUl5ubm5qWk5GLhH93cm9paWdmaWltc3h/goeLj5KTlZSUk5CPjIiGgn57d3NzcG1pa2pra3F4dXuBiIuPi5GQiIiHhoF+eXVua2VhXllRUldaZ2xnhaChob7K0djLzsK5p5uMfnJkW1JQTEtLT1NWXGNueHuDiIyVmZyenqCfm5eRjIWAenRvamhkZGZmaG1yeYGGjJOVl5qZnJmXmJSRjIaAfHdzbmhmY2JdW11eXmRpbnR7gYWMj5WZm5mfoJ+fn6CcnpmPi4RzZV1NPTsxKzI6Q0RddJKorr7K3NzZ1tXJuq2XinxxZFlQSENBRUtOU1deaHF7hY+apKmwsbGysq6nnZGGfXRrYllUUVFRU1ZeZGx4f4iQl6Clq6yqqaehmpKHf3hxaWJdWllaWl1gZmpxdnh/hIqOk5mgn6CgoZyaoJaQkYFtZ11IPzkoMz1KVm5/jZ+pvMTJyMrBu7Ckm5CFem9nYF1bV1lXWFtfY2pweYCIj5SanaKkpaKemJKMhn51cGlnZWFhYGJma292e3+Gi5CVmJqbnJ2bmpaSjoiBfnhxbWpqZmdnZ2tsbG9udXZ+goeKjJGUlJScl5WThndyYFlLRUdcYGl8g5uirKqvrq6jnZiTkIqFgHt0c29ta2poamhqaGlrcXV4fH+GiI6Qk5WUl5STkYmFgX58eXZzcXBxcXJ0dHh6fICBg4WGh4iIioyNkI2OioiGgX16dnNzcnBvcW5wcHJzeHl/gIWIi46SlJegmbCskImBVVZIOjNDP0x3dZyJvr+0uKy2oaSNkYV9e3NvbWtpaWpoa2dscnJ3dHqAhIuPjpOSmJmZmo+PhoKBeHRybWptZ2praW9zdoCBho2Lk4+PkpGQj4qKh4KDeHZwbGpramtvdHl7g4iLjZKSkZOQio9/dGReRUxXQldujX+ZqsC3o7Wloo+RioiFf394eHhyc29xcWttbXFvc3Z5fYKDiIuMj46PjY2KhoV+fXx3eXZ0dHR2c3l3eHl8gH+Eg4eGhoaFiIWGhISEgIJ9fHt/fH6AhICKiYOKhoB6gnBqYF5JTjxDUmV+iqWs0crQxMG1p5yNh3t2bGlmYV1gXmVkaWxydXt8gYiJkI6RkpOSlZKPi4WBe3ZzcGlpaGhqaW1udHh9g4iNkJKXmpiYl5aSkIiFhYJ+fXt4dm1rY2BcWlBVUkNTXXh9kqW3vba/tLeon5WLhYB7dXZwbGloZ2hmam1wdnt+hIyRlZeWmJaTkIqJgn96dHFsaGVlZGdpb3F1e36Eh4mNkZKUlJOUko6OiIR/e3p1dHJydXV3en58iY6Rj5ySfHtlWEM/NFlscIWbt663qq2nm5GIh4GAeXh0cm9vc3V4eXl+fX16enh7f4CFg4mKj5COi4eFgX56dnFvb25xcHFzc3h5e4GBhImKjoyMi4qKiIiFhIiHiIR/fn19ent8eXR5cGhiWk1Va3F9iqGrqKOnppmVjYyGgoGAe3ZvZ2hpb3J0d36Bf4OEhoqNj4yOioeHhIN/fn19fXx5eHZzdHNzcnN0dXh6fYCAhYeJiYmKio6HhICAf4GDgIKAgoOLiYOHeXBmV0FEV19wepelrK6wtqmil5KHgHx4d3Zyb21sbm1vb3JzdnZ5fICGio2PkpWWl5mXlZCHg312cWxqaGdnaWZoaWtyd32EiI+TlZWTk5GRjYmHhYSCf3t7endycXNnZGNaVlJWY3h3jKSxsrG+uLCln5SLg3p2cGxqZ2VlZWRkZ2twdHmAhIyQlJiYmJeUlZKQjIeCfXhyb21sbGxsbG1vcHR3foGHio+QkpOUlJGQjIqFhYOEfH5+cmRjRz87SFxrfIisna6qqaehoZaXj5OMioN9dG9pamlqbG9vb29tcXJ4fIGFi4+TlJWUj42Jh4WEgXt4dnRzcG1tbW1xcXR6fIKHiI2Mj4+Njo+QkJKQkYqHiX9wa11IPUlYYGh2lZWXnKahnJmUlI2Oi42Kh4WAfH17eHRxbWpoaG1udHh7fn6Ch4uQlZaXlZKOiYJ7dnJzc3R0c3JxbnBxc3d7g4aKio2OjYyMi42Nj5CLi4Jza1dLTFdecYaHmJifm5mWkoyCgnyDgIKEhIOCg4GCgX58d3NzcnR4en19fX99g4WKjIqKhoeEgX98e318fn58e3l2d3d3e31+gIKFhoSFgoODg4SFhoeCg31+f4B9gHtubUxXZXZpf5ORm5KdkZeMkIyIiIWJhYaCfXp4c3Btb29zc3d2e4GEiIiGhoWGiYeKh4WCgH97eHh5enx7enh1dXV2en1/homMjIqLi4qKiIWHiIaEhIJ2a2NHSV9nZ4GTlaCeoJuXj4qFgoCDhoWEg357enh4eHl4eXZ2dHV5e3t+fX6Bho2Oj46LiYWDgHt7enp7enhzcXFycnR4en+Dh4qJjIyMi4iGhoaIh4WHh4WAgXt0aWRTTFlvfXmHk5+YmJqZlY+MiImFhYGBgH9+fHt7dnJwcnJxcnV5fYCDgoOFhoqOkZCOjImEfnl2dHV6fHt4dHNvcXN1en6EiIuKiomJioeGiIeGhIJ+e315enl9dnh2Z11aZnGCgImYl5OOkZKSjY2MiYmGgoF8d3NxcHJ0c3Z4eXh3eX2DiYyNioqJiIeGhYODhYSBf3t3dnV1dXN0dXh6e36BhIaHiIiIiYmJiYmGhH99eHZ2d3p8fHp7d3h6fn+Bf4CCgXx3c3iJg4OLmJCNioWGgH97fHh4eXl5eXl6fH5/f4CEh4mHhYWDhYaFg4GAf398e3p6eHh3d3l5e31/gYOEhISDg4OEhISGhoOBfHx8e3t6eXt9fX17fX+AgYCCg4KFhYSEhIOBgICCgoF/f359fHl6enp8fX5/gIGCgYCCg4SFhoaGhIKBgH99fXx8eXl7fH19fX6AgIGBgoKBgoKDgoOCgYGBgH5+fn1+fX18fH1+fn9+fn6AgYKBgYGBgoKCgoKCgoGAf39+f359fn5+fn19fX5/gICAgH9/f4CAgYGCgoGAf39/fn18fHx7fX5+fn5/gYKCgYGBgYCBgoKCgX9+fXx9fHx9fn9/f4B/gIGAf3+AgYKCg4ODg4GBgoCAf39/f39/" type="audio/wav">
</audio>

    <script>
        // Platform detection
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        // Game Constants
        const GAME_CONSTANTS = {
            PLAYER_SPEED: 6.0, // Player speed in units per second
            PLAYER_MAX_X: 5,
            PLAYER_BULLET_SPEED: 30.0, // Player bullet speed in units per second
            ENEMY_BULLET_SPEED: 18.0, // Enemy bullet speed in units per second
            ENEMY_SPAWN_INTERVAL: 2000, // ms
            ENEMY_MIN_SPEED: 1.2, // Min enemy speed in units per second
            ENEMY_SPEED_RANGE: 1.8, // Additional random speed range in units per second
            ENEMY_SHOT_INTERVAL_MIN: 2000,
            ENEMY_SHOT_INTERVAL_RANGE: 2000,
            INITIAL_BULLET_COUNT: 20,
            BULLETS_PER_ENEMY_SPAWN: 2,
            INITIAL_HEALTH: 10,
            MAX_HEALTH: 10,
            EXTRA_LIFE_SCORE_THRESHOLD: 250,
            SILVER_ENEMY_BASE_SCORE_TRIGGER: 100,
            SILVER_ENEMY_SCORE_INTERVAL_MIN: 400,
            SILVER_ENEMY_SCORE_INTERVAL_RANGE: 200,
            SILVER_ENEMY_DURATION_MS: 12000, // Duration in milliseconds
            SILVER_ENEMY_SIDE_SPEED: 4.8, // Silver enemy side-to-side speed in units per second
            SILVER_ENEMY_SHOT_INTERVAL: 1000,
            BULLET_REMOVAL_Z_PLAYER: -30,
            BULLET_REMOVAL_Z_ENEMY: 10,
            ENEMY_REMOVAL_Z: 5,
            COLLISION_THRESHOLD: 1,
            BONUS_POINTS_PER_BULLET: 8,
            NORMAL_ENEMY_SCORE: 10,
            SILVER_ENEMY_SCORE_MULTIPLIER: 5,
            STAR_COUNT: 1000,
            STAR_SIZE: 0.1,
            STAR_SPREAD: 2000,
            STAR_ROTATION_SPEED: 0.03, // Radians per second
            SOUND_LASER_BASE_VOLUME: isIOS ? 0.025 : 0.15, 
            SOUND_ENEMY_LASER_BASE_VOLUME: 0.3,
            SOUND_DEFAULT_BASE_VOLUME: 0.5,
            SOUND_MAX_CLONES: isIOS ? 2 : 5, 
        };

        // Game State
        let animationFrameId;
        let lastFrameTimestamp = 0; // For delta time calculation
        const gameState = {
            score: 0,
            health: GAME_CONSTANTS.INITIAL_HEALTH,
            enemies: [],
            bullets: [],
            enemyBullets: [],
            gameOver: false,
            gameStarted: false,
            moveLeft: false,
            moveRight: false,
            lastEnemySpawnTime: 0,
            bulletCount: GAME_CONSTANTS.INITIAL_BULLET_COUNT,
            lastLifeGainedAtScore: 0,
            silverEnemyActive: false,
            silverEnemyTimer: 0,
            silverEnemyDirection: 1,
            nextSilverEnemyScore: GAME_CONSTANTS.SILVER_ENEMY_BASE_SCORE_TRIGGER,
        };

        // DOM Elements
        const domElements = {
            startScreen: document.getElementById('start-screen'), // Corrected ID
            gameContainer: document.getElementById('game-container'),
            scoreDisplay: document.getElementById('score'),
            healthBar: document.getElementById('health-bar'),
            bulletsDisplay: document.getElementById('bullets-display'),
            gameOverScreen: document.getElementById('game-over'),
            // gameOverScoreDisplay: document.getElementById('game-over-score'), // Removed
            // bulletsRemainingDisplay: document.getElementById('bullets-remaining'), // Removed
            // finalScoreDisplay: document.getElementById('final-score'), // Removed (old one for game-over div)
            startScreen: document.getElementById('start-screen'),
            infoModal: document.getElementById('info-modal'),
            soundToggleBtn: document.getElementById('sound-toggle'),
            fartCheckbox: document.getElementById('fart-sound-checkbox'),
            controlsBar: document.getElementById('controls'),
        };
        
        // Three.js Scene Setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x000033);
        domElements.gameContainer.appendChild(renderer.domElement);

        // Pre-create Geometries
        const GEOMETRIES = {
            // Player
            playerHull: new THREE.CylinderGeometry(0.3, 0.5, 2, 8),
            playerCockpit: new THREE.SphereGeometry(0.3, 16, 16, 0, Math.PI * 2, 0, Math.PI / 2),
            playerWing: new THREE.BoxGeometry(1.8, 0.1, 0.8),
            playerEngineGlow: new THREE.CircleGeometry(0.2, 16),
            playerCannon: new THREE.CylinderGeometry(0.05, 0.05, 0.6, 8),
            // Bullets
            bullet: new THREE.SphereGeometry(0.1, 16, 16),
            // Enemies
            enemyType0Hull: new THREE.ConeGeometry(0.5, 1.5, 3),
            enemyType0Fin: new THREE.BoxGeometry(1.2, 0.1, 0.5),
            enemyType0Weapon: new THREE.BoxGeometry(0.7, 0.15, 0.15),
            enemyType1Hull: new THREE.SphereGeometry(0.5, 16, 8, 0, Math.PI * 2, 0, Math.PI * 0.6),
            enemyType1Dome: new THREE.SphereGeometry(0.25, 16, 8, 0, Math.PI * 2, 0, Math.PI * 0.5),
            enemyType1Ring: new THREE.TorusGeometry(0.6, 0.1, 8, 16),
            enemyType2Hull: new THREE.BoxGeometry(0.8, 0.3, 1.8),
            enemyType2Top: new THREE.BoxGeometry(0.4, 0.2, 0.6),
            enemyType2Pod: new THREE.CylinderGeometry(0.15, 0.15, 0.6, 8),
            enemyCannon: new THREE.CylinderGeometry(0.08, 0.08, 0.5, 8),
            enemyEngineGlow: new THREE.CircleGeometry(0.15, 16),
            // Silver Enemy (scaled versions)
            silverEnemyHull: new THREE.BoxGeometry(0.6, 0.24, 1.2),
            silverEnemyTop: new THREE.BoxGeometry(0.3, 0.18, 0.48),
            silverEnemyPod: new THREE.CylinderGeometry(0.12, 0.12, 0.48, 8),
            silverEnemyCannon: new THREE.CylinderGeometry(0.048, 0.048, 0.36, 8),
            silverEnemyEngineGlow: new THREE.CircleGeometry(0.12, 16),
            silverEnemyOuterGlow: new THREE.SphereGeometry(0.72, 16, 16),
            // Stars
            stars: new THREE.BufferGeometry(),
        };

        const MATERIALS = {
            // Player
            playerHull: new THREE.MeshPhongMaterial({ color: 0x0088FF }),
            playerCockpit: new THREE.MeshPhongMaterial({ color: 0x66CCFF, transparent: true, opacity: 0.7 }),
            playerWing: new THREE.MeshPhongMaterial({ color: 0x0066CC }),
            playerEngineGlow: new THREE.MeshBasicMaterial({ color: 0x00FFFF }),
            playerCannon: new THREE.MeshPhongMaterial({ color: 0x888888 }),
            // Bullets
            playerBullet: new THREE.MeshPhongMaterial({ color: 0xFFFF00 }),
            enemyBullet: new THREE.MeshPhongMaterial({ color: 0xFF00FF }),
            // Enemies
            enemyType0Hull: new THREE.MeshPhongMaterial({ color: 0xFF0000 }),
            enemyType0Fin: new THREE.MeshPhongMaterial({ color: 0xCC0000 }),
            enemyType0Weapon: new THREE.MeshPhongMaterial({ color: 0x880000 }),
            enemyType1Hull: new THREE.MeshPhongMaterial({ color: 0xFF4400 }),
            enemyType1Dome: new THREE.MeshPhongMaterial({ color: 0xFF8800, transparent: true, opacity: 0.7 }),
            enemyType1Ring: new THREE.MeshPhongMaterial({ color: 0xCC4400 }),
            enemyType2Hull: new THREE.MeshPhongMaterial({ color: 0xFF0066 }),
            enemyType2Top: new THREE.MeshPhongMaterial({ color: 0xCC0066 }),
            enemyType2Pod: new THREE.MeshPhongMaterial({ color: 0x880044 }),
            enemyCannon: new THREE.MeshPhongMaterial({ color: 0x888888 }),
            enemyEngineGlow: new THREE.MeshBasicMaterial({ color: 0xFF6600 }),
            // Silver Enemy
            silverEnemyHull: new THREE.MeshPhongMaterial({ color: 0xC0C0C0 }),
            silverEnemyTop: new THREE.MeshPhongMaterial({ color: 0xA0A0A0 }),
            silverEnemyPod: new THREE.MeshPhongMaterial({ color: 0x808080 }),
            silverEnemyEngineGlow: new THREE.MeshBasicMaterial({ color: 0x00FFFF }),
            silverEnemyOuterGlow: new THREE.MeshBasicMaterial({ color: 0xCCCCFF, transparent: true, opacity: 0.3 }),
            // Stars
            stars: new THREE.PointsMaterial({ color: 0xFFFFFF, size: GAME_CONSTANTS.STAR_SIZE, transparent: true }),
        };

        // Sound Manager
        const SoundManager = {
            sounds: {},
            soundClonePools: new Map(),
            enabled: true,
            initialized: false,
            audioContext: null,
            masterVolume: 1.0, // General master volume, can be controlled by user eventually

            init() {
                if (this.initialized) return;
                try {
                    // Ensure AudioContext is created or resumed
                    if (!this.audioContext || this.audioContext.state === 'closed') {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume().catch(e => console.warn('Could not resume audio context during init:', e));
                    }

                    document.querySelectorAll('audio').forEach(audio => {
                        this.sounds[audio.id] = audio;
                        if (isMobile || isIOS) audio.load(); // Preload for mobile/iOS

                        const pool = [];
                        for (let i = 0; i < GAME_CONSTANTS.SOUND_MAX_CLONES; i++) {
                            const clone = audio.cloneNode(true);
                            pool.push(clone);
                        }
                        this.soundClonePools.set(audio.id, pool);
                    });
                    
                    this.setVolume(this.masterVolume); // Apply initial volumes
                    this.toggle(this.enabled, true); // Apply initial muted state

                    this.initialized = true;
                    console.log('SoundManager initialized with', Object.keys(this.sounds).length, 'sounds. Max clones:', GAME_CONSTANTS.SOUND_MAX_CLONES);
                } catch (e) {
                    console.error('Error initializing SoundManager:', e);
                    this.initialized = true; // Mark as initialized to prevent repeated errors
                }
            },

            getSoundClone(id) {
                const pool = this.soundClonePools.get(id);
                if (!pool || pool.length === 0) return this.sounds[id]; // Fallback to original if no pool or empty

                let clone = pool.find(c => c.paused || c.ended);
                if (!clone) { // If all clones are busy, reuse the one that started earliest (approximated)
                    // For simplicity, just reuse the first one. A more complex strategy could track play start times.
                    console.warn(`Sound clone pool for '${id}' exhausted, reusing first clone.`);
                    clone = pool[0];
                }
                return clone; 
            },

            play(id, options = {}) {
                if (!this.initialized) {
                    console.warn(`SoundManager not initialized. Cannot play sound '${id}'. Game start should init sounds.`);
                    return;
                }
                if (!this.enabled) return;

                try {
                    const useClone = options.rapidFire || ['laser-sound', 'enemy-laser-sound', 'fart-sound', 'player-hit-sound', 'enemy-destroyed-sound'].includes(id);
                    const sound = useClone ? this.getSoundClone(id) : this.sounds[id];

                    if (!sound) {
                        console.warn(`Sound '${id}' not found`);
                        return;
                    }
                    
                    if (this.audioContext && this.audioContext.state === 'suspended') {
                        this.audioContext.resume().catch(e => console.warn('Could not resume audio context on play:', e));
                    }

                    // Ensure sound is not muted if globally enabled (some browsers might reset this)
                    sound.muted = false;

                    if (options.forceRestart || sound.paused || sound.ended || sound.currentTime > 0) { // Also restart if already playing for rapid fire
                        sound.currentTime = 0;
                    }
                    
                    const playPromise = sound.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(e => {
                            if (e.name === 'NotAllowedError' || e.name === 'NotSupportedError') {
                                 console.warn(`Playback prevented for sound '${id}': ${e.message}. User interaction might be required or audio context is locked.`);
                            } else {
                                console.error(`Error playing sound '${id}':`, e);
                            }
                        });
                    }
                } catch (e) {
                    console.error(`Error in SoundManager.play('${id}'):`, e);
                }
            },

            stop(id) {
                if (!this.initialized) return;
                const sound = this.sounds[id];
                if (sound) {
                    sound.pause();
                    sound.currentTime = 0;
                }
                this.soundClonePools.get(id)?.forEach(clone => {
                    clone.pause();
                    clone.currentTime = 0;
                });
            },
            
            // Sets the master volume and updates all sounds
            setMasterVolume(volume) {
                this.masterVolume = Math.max(0, Math.min(1, volume)); // Clamp between 0 and 1
                this.setVolume(this.masterVolume);
            },

            // Internal method to apply volume to all sounds based on master and base volumes
            setVolume(currentMasterVolume) {
                if (!this.initialized && Object.keys(this.sounds).length === 0) return; // Don't try if not initted

                const applyVol = (s, id) => {
                    let baseVolume = GAME_CONSTANTS.SOUND_DEFAULT_BASE_VOLUME;
                    if (id === 'laser-sound') baseVolume = GAME_CONSTANTS.SOUND_LASER_BASE_VOLUME;
                    else if (id === 'enemy-laser-sound') baseVolume = GAME_CONSTANTS.SOUND_ENEMY_LASER_BASE_VOLUME;
                    s.volume = Math.min(currentMasterVolume, baseVolume);
                };

                Object.entries(this.sounds).forEach(([id, sound]) => applyVol(sound, id));
                this.soundClonePools.forEach((pool, id) => {
                    pool.forEach(clone => applyVol(clone, id));
                });
            },

            toggle(enable = null, forceUpdate = false) {
                const oldEnabledState = this.enabled;
                this.enabled = enable !== null ? enable : !this.enabled;
                
                if (!this.initialized && !forceUpdate) { // If not initialized and not forced, just store preference
                    localStorage.setItem('soundEnabled', this.enabled.toString());
                     if (domElements.soundToggleBtn) {
                        domElements.soundToggleBtn.textContent = this.enabled ? '🔊' : '🔇';
                        domElements.soundToggleBtn.setAttribute('aria-label', this.enabled ? 'Mute sound' : 'Unmute sound');
                    }
                    return this.enabled;
                }

                // If state didn't change and not forced, do nothing
                if (oldEnabledState === this.enabled && !forceUpdate) return this.enabled;

                const updateSoundMuteState = (sound) => {
                    if (sound) {
                        sound.muted = !this.enabled;
                    }
                };

                Object.values(this.sounds).forEach(updateSoundMuteState);
                this.soundClonePools.forEach(pool => pool.forEach(updateSoundMuteState));

                if (domElements.soundToggleBtn) {
                    domElements.soundToggleBtn.textContent = this.enabled ? '🔊' : '🔇';
                    domElements.soundToggleBtn.setAttribute('aria-label', this.enabled ? 'Mute sound' : 'Unmute sound');
                }
                localStorage.setItem('soundEnabled', this.enabled.toString());
                console.log('Sound', this.enabled ? 'enabled' : 'disabled');
                
                // If enabling sounds and audio context was suspended, try to resume
                if (this.enabled && this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume().catch(e => console.warn('Could not resume audio context on toggle:', e));
                }

                return this.enabled;
            },

            stopAllSounds(options = {}) {
                if (!this.initialized) return;
                Object.entries(this.sounds).forEach(([id, sound]) => {
                    if (options.except && id === options.except) return;
                    sound.pause();
                    sound.currentTime = 0;
                });
                this.soundClonePools.forEach((pool, soundId) => {
                    if (options.except && soundId === options.except) return;
                    pool.forEach(clone => {
                        clone.pause();
                        clone.currentTime = 0;
                    });
                });
                console.log('All sounds stopped.');
            },

            initializeOnFirstPlay() {
                // This should be called within a user gesture (e.g. 'click' on Start Game button)
                if (this.initialized) return true;
                console.log("Attempting to initialize SoundManager on first play trigger.");

                return new Promise((resolve, reject) => {
                    try {
                        if (!this.audioContext || this.audioContext.state === 'closed') {
                            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        }

                        if (this.audioContext.state === 'suspended') {
                            this.audioContext.resume().then(() => {
                                console.log('AudioContext resumed successfully.');
                                this.init(); // Now initialize sounds
                                resolve(true);
                            }).catch(e => {
                                console.warn('AudioContext resume failed:', e);
                                // Still try to init, might work without context for basic HTMLAudio
                                this.init();
                                reject(e);
                            });
                        } else {
                            console.log('AudioContext already running or ready.');
                            this.init(); // Initialize sounds
                            resolve(true);
                        }
                    } catch (e) {
                        console.error('Error creating/resuming AudioContext:', e);
                        this.init(); // Fallback: attempt to init without a fully working context
                        reject(e);
                    }
                });
            }
        };
        
        // Initialize sound enabled state from localStorage
        const savedSoundPref = localStorage.getItem('soundEnabled');
        if (savedSoundPref !== null) {
            SoundManager.toggle(savedSoundPref === 'true', true); // Force update UI
        }


        // Player Ship
        const player = new THREE.Group();
        function createPlayer() {
            player.position.set(0, -1, -5);

            const hull = new THREE.Mesh(GEOMETRIES.playerHull, MATERIALS.playerHull);
            hull.rotation.x = Math.PI / 2;
            player.add(hull);

            const cockpit = new THREE.Mesh(GEOMETRIES.playerCockpit, MATERIALS.playerCockpit);
            cockpit.position.y = 0.3;
            player.add(cockpit);

            const wings = new THREE.Mesh(GEOMETRIES.playerWing, MATERIALS.playerWing);
            wings.position.y = -0.1;
            player.add(wings);

            const engineGlow = new THREE.Mesh(GEOMETRIES.playerEngineGlow, MATERIALS.playerEngineGlow);
            engineGlow.position.z = 1;
            engineGlow.rotation.y = Math.PI;
            player.add(engineGlow);

            const cannonLeft = new THREE.Mesh(GEOMETRIES.playerCannon, MATERIALS.playerCannon);
            cannonLeft.position.set(-0.3, 0, -0.8);
            cannonLeft.rotation.x = Math.PI / 2;
            player.add(cannonLeft);

            const cannonRight = new THREE.Mesh(GEOMETRIES.playerCannon, MATERIALS.playerCannon);
            cannonRight.position.set(0.3, 0, -0.8);
            cannonRight.rotation.x = Math.PI / 2;
            player.add(cannonRight);
            
            scene.add(player);
        }
        createPlayer();


        // Lights
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xFFFFFF, 0.5);
        directionalLight.position.set(0, 1, 1);
        scene.add(directionalLight);

        // Stars Background
        const starsVertices = [];
        for (let i = 0; i < GAME_CONSTANTS.STAR_COUNT; i++) {
            const x = (Math.random() - 0.5) * GAME_CONSTANTS.STAR_SPREAD;
            const y = (Math.random() - 0.5) * GAME_CONSTANTS.STAR_SPREAD;
            const z = (Math.random() - 0.5) * GAME_CONSTANTS.STAR_SPREAD;
            starsVertices.push(x, y, z);
        }
        GEOMETRIES.stars.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
        const stars = new THREE.Points(GEOMETRIES.stars, MATERIALS.stars);
        scene.add(stars);

        // Camera Position
        camera.position.set(0, 2, 5);
        camera.lookAt(0, 0, -10);

        // UI Functions
        function updateHealthUI() {
            const healthPercent = (gameState.health / GAME_CONSTANTS.MAX_HEALTH) * 100;
            domElements.healthBar.style.width = `${healthPercent}%`;
            
            if (gameState.health >= 7) domElements.healthBar.style.background = '#4CAF50'; // Green
            else if (gameState.health >= 4) domElements.healthBar.style.background = '#FFC107'; // Yellow
            else domElements.healthBar.style.background = '#F44336'; // Red
        }

        function updateBulletDisplayUI() {
            domElements.bulletsDisplay.textContent = gameState.bulletCount;
            if (gameState.bulletCount <= 5) {
                domElements.bulletsDisplay.style.color = '#FF3333';
                domElements.bulletsDisplay.style.textShadow = '0 0 10px #FF0000, 0 0 20px #FF0000';
            } else {
                domElements.bulletsDisplay.style.color = '#CCCCCC';
                domElements.bulletsDisplay.style.textShadow = '0 0 10px #00FF00, 0 0 20px #00FF00';
            }
        }

        function updateScoreUI(points = GAME_CONSTANTS.NORMAL_ENEMY_SCORE) {
            gameState.score += points;
            domElements.scoreDisplay.textContent = gameState.score;

            // Check for Star Wars Crawl trigger
            if (gameState.score >= 100 && !window.crawlHasPlayed) {
                window.startStarWarsCrawl();
            }
            
            if (gameState.health < GAME_CONSTANTS.MAX_HEALTH && gameState.score >= gameState.lastLifeGainedAtScore + GAME_CONSTANTS.EXTRA_LIFE_SCORE_THRESHOLD) {
                gameState.health++;
                gameState.lastLifeGainedAtScore = Math.floor(gameState.score / GAME_CONSTANTS.EXTRA_LIFE_SCORE_THRESHOLD) * GAME_CONSTANTS.EXTRA_LIFE_SCORE_THRESHOLD;
                updateHealthUI();
                // SoundManager.play('extra-life-sound'); // Add an extra life sound if you have one
                console.log('Extra life gained at score:', gameState.score);
            }
        }
        
        function showBonusPointsText(points) {
            const bonusText = document.createElement('div');
            bonusText.textContent = `+${points} POINTS!`;
            bonusText.style.position = 'absolute';
            bonusText.style.top = '40%';
            bonusText.style.left = '50%';
            bonusText.style.transform = 'translate(-50%, -50%)';
            bonusText.style.color = '#FFFF00';
            bonusText.style.fontSize = '20px';
            bonusText.style.fontFamily = "'Press Start 2P', cursive";
            bonusText.style.textShadow = '0 0 10px #FFFF00';
            bonusText.style.zIndex = '1000';
            bonusText.style.pointerEvents = 'none';
            document.body.appendChild(bonusText);
            
            let posY = 40;
            let opacity = 1;
            const animInterval = setInterval(() => {
                posY -= 0.5;
                opacity -= 0.02;
                bonusText.style.top = `${posY}%`;
                bonusText.style.opacity = opacity;
                if (opacity <= 0) {
                    clearInterval(animInterval);
                    if (bonusText.parentElement) document.body.removeChild(bonusText);
                }
            }, 30);
        }

        // Game Logic Functions
        function fireBullet() {
            if (gameState.gameOver || !gameState.gameStarted || gameState.bulletCount <= 0) return;
            
            gameState.bulletCount--;
            updateBulletDisplayUI();
            
            SoundManager.play('laser-sound', { rapidFire: true });
            
            const bullet = new THREE.Mesh(GEOMETRIES.bullet, MATERIALS.playerBullet);
            bullet.position.copy(player.position);
            bullet.position.z -= 2; 
            bullet.userData.velocity = new THREE.Vector3(0, 0, -GAME_CONSTANTS.PLAYER_BULLET_SPEED);
            
            scene.add(bullet);
            gameState.bullets.push(bullet);
        }

        function enemyFire(enemy) {
            if (gameState.gameOver) return;
            
            SoundManager.play('enemy-laser-sound', { rapidFire: true });
            
            const bullet = new THREE.Mesh(GEOMETRIES.bullet, MATERIALS.enemyBullet);
            const worldPosition = new THREE.Vector3();
            enemy.getWorldPosition(worldPosition);
            bullet.position.copy(worldPosition);
            bullet.position.z += 2; 
            
            const direction = new THREE.Vector3();
            direction.subVectors(player.position, bullet.position).normalize();
            bullet.userData.velocity = direction.multiplyScalar(GAME_CONSTANTS.ENEMY_BULLET_SPEED);
            
            scene.add(bullet);
            gameState.enemyBullets.push(bullet);
        }

        function spawnEnemy() {
            const enemy = new THREE.Group();
            enemy.position.x = (Math.random() - 0.5) * 10;
            enemy.position.y = -1;
            enemy.position.z = -30;
            
            gameState.bulletCount += GAME_CONSTANTS.BULLETS_PER_ENEMY_SPAWN;
            updateBulletDisplayUI();
            
            const enemyType = Math.floor(Math.random() * 3);
            let enemyHull, enemyCannonMesh;

            // Common parts
            const engineGlow = new THREE.Mesh(GEOMETRIES.enemyEngineGlow, MATERIALS.enemyEngineGlow);
            engineGlow.position.z = -0.9; // Back of the enemy
            engineGlow.rotation.y = Math.PI;
            enemy.add(engineGlow);

            enemyCannonMesh = new THREE.Mesh(GEOMETRIES.enemyCannon, MATERIALS.enemyCannon);
            enemyCannonMesh.rotation.x = Math.PI / 2;
            enemyCannonMesh.position.z = 0.8; // Front of the enemy
            enemy.add(enemyCannonMesh);

            if (enemyType === 0) { // Triangular fighter
                enemyHull = new THREE.Mesh(GEOMETRIES.enemyType0Hull, MATERIALS.enemyType0Hull);
                enemyHull.rotation.x = Math.PI / 2;
                enemyHull.rotation.z = Math.PI;
                enemy.add(enemyHull);
                const fins = new THREE.Mesh(GEOMETRIES.enemyType0Fin, MATERIALS.enemyType0Fin);
                fins.position.z = 0.4;
                enemy.add(fins);
            } else if (enemyType === 1) { // Saucer ship
                enemyHull = new THREE.Mesh(GEOMETRIES.enemyType1Hull, MATERIALS.enemyType1Hull);
                // hull.rotation.x = Math.PI; // Orient opening downwards // This was causing error, 'hull' not defined
                enemyHull.rotation.x = Math.PI;
                enemy.add(enemyHull);
                const dome = new THREE.Mesh(GEOMETRIES.enemyType1Dome, MATERIALS.enemyType1Dome);
                dome.position.y = 0.2;
                enemy.add(dome);
                const ring = new THREE.Mesh(GEOMETRIES.enemyType1Ring, MATERIALS.enemyType1Ring);
                ring.rotation.x = Math.PI / 2;
                ring.position.y = -0.1;
                enemy.add(ring);
            } else { // Rectangular cruiser
                enemyHull = new THREE.Mesh(GEOMETRIES.enemyType2Hull, MATERIALS.enemyType2Hull);
                enemy.add(enemyHull);
                const top = new THREE.Mesh(GEOMETRIES.enemyType2Top, MATERIALS.enemyType2Top);
                top.position.y = 0.25;
                enemy.add(top);
                const leftPod = new THREE.Mesh(GEOMETRIES.enemyType2Pod, MATERIALS.enemyType2Pod);
                leftPod.rotation.z = Math.PI / 2;
                leftPod.position.set(-0.5, 0, 0);
                enemy.add(leftPod);
                const rightPod = new THREE.Mesh(GEOMETRIES.enemyType2Pod, MATERIALS.enemyType2Pod);
                rightPod.rotation.z = Math.PI / 2;
                rightPod.position.set(0.5, 0, 0);
                enemy.add(rightPod);
            }
            
            enemy.userData.speed = GAME_CONSTANTS.ENEMY_MIN_SPEED + Math.random() * GAME_CONSTANTS.ENEMY_SPEED_RANGE;
            enemy.userData.lastShotTime = 0;
            enemy.userData.shotInterval = GAME_CONSTANTS.ENEMY_SHOT_INTERVAL_MIN + Math.random() * GAME_CONSTANTS.ENEMY_SHOT_INTERVAL_RANGE;
            enemy.userData.isSilverEnemy = false;
            
            scene.add(enemy);
            gameState.enemies.push(enemy);
        }

        function spawnSilverEnemy() {
            const enemy = new THREE.Group();
            enemy.position.x = (Math.random() - 0.5) * 8;
            enemy.position.y = -1;
            enemy.position.z = -30; // Start depth

            gameState.bulletCount += GAME_CONSTANTS.BULLETS_PER_ENEMY_SPAWN + 1; // Extra bullet for silver
            updateBulletDisplayUI();

            const hull = new THREE.Mesh(GEOMETRIES.silverEnemyHull, MATERIALS.silverEnemyHull);
            enemy.add(hull);
            const top = new THREE.Mesh(GEOMETRIES.silverEnemyTop, MATERIALS.silverEnemyTop);
            top.position.y = 0.21;
            enemy.add(top);
            const leftPod = new THREE.Mesh(GEOMETRIES.silverEnemyPod, MATERIALS.silverEnemyPod);
            leftPod.rotation.z = Math.PI / 2;
            leftPod.position.set(-0.36, 0, 0);
            enemy.add(leftPod);
            const rightPod = new THREE.Mesh(GEOMETRIES.silverEnemyPod, MATERIALS.silverEnemyPod);
            rightPod.rotation.z = Math.PI / 2;
            rightPod.position.set(0.36, 0, 0);
            enemy.add(rightPod);

            const leftCannon = new THREE.Mesh(GEOMETRIES.silverEnemyCannon, MATERIALS.playerCannon); // Re-use material
            leftCannon.rotation.x = Math.PI / 2;
            leftCannon.position.set(-0.18, 0, 0.6);
            enemy.add(leftCannon);
            const rightCannon = new THREE.Mesh(GEOMETRIES.silverEnemyCannon, MATERIALS.playerCannon);
            rightCannon.rotation.x = Math.PI / 2;
            rightCannon.position.set(0.18, 0, 0.6);
            enemy.add(rightCannon);
            
            const engineGlow = new THREE.Mesh(GEOMETRIES.silverEnemyEngineGlow, MATERIALS.silverEnemyEngineGlow);
            engineGlow.position.z = -0.6;
            engineGlow.rotation.y = Math.PI;
            enemy.add(engineGlow);

            const outerGlow = new THREE.Mesh(GEOMETRIES.silverEnemyOuterGlow, MATERIALS.silverEnemyOuterGlow);
            enemy.add(outerGlow);
            
            // Silver enemy moves side to side at fixed depth, does not use userData.speed for Z movement
            enemy.userData.lastShotTime = 0;
            enemy.userData.shotInterval = GAME_CONSTANTS.SILVER_ENEMY_SHOT_INTERVAL;
            enemy.userData.isSilverEnemy = true;
            
            scene.add(enemy);
            gameState.enemies.push(enemy);
            gameState.silverEnemyActive = true;
            gameState.silverEnemyTimer = 0;
            gameState.silverEnemyDirection = (Math.random() < 0.5) ? 1 : -1; // Random initial direction

            SoundManager.play('silver-enemy-sound');
            console.log('Silver enemy spawned at score:', gameState.score);
        }

        function handlePlayerHit() {
            gameState.health--;
            if (gameState.health <= 0) {
                SoundManager.play('game-over-sound');
                endGame();
            } else {
                SoundManager.play('player-hit-sound', { rapidFire: true });
            }
            updateHealthUI();
        }
        
        function endGame() {
            gameState.gameOver = true;
            const bonusPoints = gameState.bulletCount * GAME_CONSTANTS.BONUS_POINTS_PER_BULLET;
            const finalScore = gameState.score + bonusPoints;
            
            domElements.gameOverScoreDisplay.textContent = gameState.score;
            domElements.bulletsRemainingDisplay.textContent = gameState.bulletCount;
            domElements.finalScoreDisplay.textContent = finalScore;
            domElements.gameOverScreen.style.display = 'flex';
            
            SoundManager.stop('silver-enemy-sound'); // Ensure it stops
        }

        function checkCollisions() {
            // Player bullets hitting enemies
            for (let i = gameState.bullets.length - 1; i >= 0; i--) {
                const bullet = gameState.bullets[i];
                for (let j = gameState.enemies.length - 1; j >= 0; j--) {
                    const enemy = gameState.enemies[j];
                    if (bullet.position.distanceTo(enemy.position) < GAME_CONSTANTS.COLLISION_THRESHOLD) {
                        scene.remove(bullet);
                        gameState.bullets.splice(i, 1);
                        
                        const isFartSound = domElements.fartCheckbox.checked;
                        SoundManager.play(isFartSound ? 'fart-sound' : 'enemy-destroyed-sound', { rapidFire: true });
                        
                        scene.remove(enemy);
                        const removedEnemy = gameState.enemies.splice(j, 1)[0]; // Get the removed enemy
                        
                        if (removedEnemy.userData.isSilverEnemy) {
                            const points = GAME_CONSTANTS.NORMAL_ENEMY_SCORE * GAME_CONSTANTS.SILVER_ENEMY_SCORE_MULTIPLIER;
                            updateScoreUI(points);
                            showBonusPointsText(points);
                            gameState.silverEnemyActive = false;
                            SoundManager.stop('silver-enemy-sound');
                            console.log('Silver enemy destroyed! +', points, 'points');
                        } else {
                            updateScoreUI(GAME_CONSTANTS.NORMAL_ENEMY_SCORE);
                        }
                        break; // Bullet can only hit one enemy
                    }
                }
            }
            
            // Enemy bullets hitting player
            for (let i = gameState.enemyBullets.length - 1; i >= 0; i--) {
                const bullet = gameState.enemyBullets[i];
                if (bullet.position.distanceTo(player.position) < GAME_CONSTANTS.COLLISION_THRESHOLD) {
                    scene.remove(bullet);
                    gameState.enemyBullets.splice(i, 1);
                    handlePlayerHit();
                    break; // Player can be hit by multiple bullets, but one bullet hits once
                }
            }
        }
        
        // Game Loop Updates
        function updatePlayer(deltaTime) {
            if (gameState.moveLeft && player.position.x > -GAME_CONSTANTS.PLAYER_MAX_X) {
                player.position.x -= GAME_CONSTANTS.PLAYER_SPEED * deltaTime;
            }
            if (gameState.moveRight && player.position.x < GAME_CONSTANTS.PLAYER_MAX_X) {
                player.position.x += GAME_CONSTANTS.PLAYER_SPEED * deltaTime;
            }
        }

        function updateBulletsCollection(bulletsArray, removalZ, deltaTime) {
            for (let i = bulletsArray.length - 1; i >= 0; i--) {
                const bullet = bulletsArray[i];
                bullet.position.addScaledVector(bullet.userData.velocity, deltaTime);
                
                let outOfBounds = false;
                if (bullet.userData.velocity.z < 0) { // Player bullet moving away from camera
                    outOfBounds = bullet.position.z < removalZ;
                } else { // Enemy bullet moving towards camera
                    outOfBounds = bullet.position.z > removalZ;
                }

                if (outOfBounds) {
                    scene.remove(bullet);
                    bulletsArray.splice(i, 1);
                }
            }
        }

        function updateEnemies(currentTime, deltaTime) {
            for (let i = gameState.enemies.length - 1; i >= 0; i--) {
                const enemy = gameState.enemies[i];
                
                if (enemy.userData.isSilverEnemy) {
                    enemy.position.x += GAME_CONSTANTS.SILVER_ENEMY_SIDE_SPEED * gameState.silverEnemyDirection * deltaTime;
                    if (enemy.position.x > GAME_CONSTANTS.PLAYER_MAX_X -1 || enemy.position.x < -GAME_CONSTANTS.PLAYER_MAX_X + 1) {
                         gameState.silverEnemyDirection *= -1; // Reverse direction
                         enemy.position.x = Math.max(-GAME_CONSTANTS.PLAYER_MAX_X + 1, Math.min(GAME_CONSTANTS.PLAYER_MAX_X -1, enemy.position.x)); // Clamp
                    }
                } else {
                    enemy.position.z += enemy.userData.speed * deltaTime;
                }
                
                if (enemy.position.z > GAME_CONSTANTS.ENEMY_REMOVAL_Z) {
                    scene.remove(enemy);
                    const removedEnemy = gameState.enemies.splice(i, 1)[0];
                    if (removedEnemy.userData.isSilverEnemy) {
                        gameState.silverEnemyActive = false;
                        SoundManager.stop('silver-enemy-sound');
                         console.log('Silver enemy flew past.');
                    }
                    continue;
                }
                
                if (currentTime - enemy.userData.lastShotTime > enemy.userData.shotInterval) {
                    enemyFire(enemy);
                    enemy.userData.lastShotTime = currentTime;
                    if (enemy.userData.isSilverEnemy && Math.random() < 0.5) {
                        setTimeout(() => { // Second shot for silver enemy
                            if (!gameState.gameOver && enemy.parent === scene) enemyFire(enemy);
                        }, 200);
                    }
                }
            }
        }
        
        function manageSilverEnemyState(deltaTime) {
            if (gameState.silverEnemyActive) {
                gameState.silverEnemyTimer += deltaTime; // Accumulate seconds
                if (gameState.silverEnemyTimer * 1000 > GAME_CONSTANTS.SILVER_ENEMY_DURATION_MS) { // Compare in MS
                    SoundManager.stop('silver-enemy-sound');
                    for (let i = gameState.enemies.length - 1; i >= 0; i--) {
                        if (gameState.enemies[i].userData.isSilverEnemy) {
                            scene.remove(gameState.enemies[i]);
                            gameState.enemies.splice(i, 1);
                            break;
                        }
                    }
                    gameState.silverEnemyActive = false;
                    gameState.silverEnemyTimer = 0;
                    console.log('Silver enemy timed out.');
                }
            }
        }

        function attemptSpawnSilverEnemy() {
             if (gameState.score >= gameState.nextSilverEnemyScore && !gameState.silverEnemyActive) {
                // Check less frequently than every frame, e.g., 1% chance per enemy spawn interval tick
                if (Math.random() < 0.2) { // Increased chance for testing, was 0.1
                    spawnSilverEnemy();
                    gameState.nextSilverEnemyScore = gameState.score + GAME_CONSTANTS.SILVER_ENEMY_SCORE_INTERVAL_MIN + Math.floor(Math.random() * GAME_CONSTANTS.SILVER_ENEMY_SCORE_INTERVAL_RANGE);
                }
            }
        }


        // Main Game Loop
        function animate(timestamp) { // timestamp is provided by setAnimationLoop
            // requestAnimationFrame(animate); // Removed, as renderer.setAnimationLoop handles the loop
            if (gameState.gameOver || !gameState.gameStarted) {
                // If game is over or not started, we might want to stop the loop
                // or just not update game logic. For now, just return.
                // To stop: renderer.setAnimationLoop(null);
                return;
            }

            if (lastFrameTimestamp === 0) { // First frame initialization
                lastFrameTimestamp = timestamp;
            }
            const deltaTime = (timestamp - lastFrameTimestamp) / 1000; // deltaTime in seconds
            lastFrameTimestamp = timestamp;

            // IMPORTANT: For Step 1, deltaTime is calculated but NOT YET USED by game logic.
            // Game will likely run very fast.

            
            const currentTime = Date.now();

            updatePlayer(deltaTime);
            updateBulletsCollection(gameState.bullets, GAME_CONSTANTS.BULLET_REMOVAL_Z_PLAYER, deltaTime);
            updateBulletsCollection(gameState.enemyBullets, GAME_CONSTANTS.BULLET_REMOVAL_Z_ENEMY, deltaTime);
            updateEnemies(currentTime, deltaTime);
            
            manageSilverEnemyState(deltaTime); // Handles active silver enemy timer and removal

            if (currentTime - gameState.lastEnemySpawnTime > GAME_CONSTANTS.ENEMY_SPAWN_INTERVAL) {
                spawnEnemy();
                gameState.lastEnemySpawnTime = currentTime;
                attemptSpawnSilverEnemy(); // Check for silver enemy spawn opportunity
            }
            
            checkCollisions();
            
            stars.rotation.y += GAME_CONSTANTS.STAR_ROTATION_SPEED * deltaTime;
            renderer.render(scene, camera);
        }

        // Game Flow Control
        async function startGame() {
            // Crucial for mobile/iOS sound: initialize within a user gesture.
            try {
                await SoundManager.initializeOnFirstPlay();
            } catch (error) {
                console.warn("Sound initialization potentially problematic:", error);
            }


            gameState.gameStarted = true;
            gameState.gameOver = false;
            if (domElements.startScreen) domElements.startScreen.style.display = 'none'; // Check if exists
            // domElements.gameOverScreen.style.display = 'none'; // Old game over screen, now removed
            document.getElementById('leaderboardScreen').style.display = 'none'; // Hide combined screen

            // Reset game state variables
            gameState.score = 0;
            gameState.health = GAME_CONSTANTS.INITIAL_HEALTH;
            gameState.bulletCount = GAME_CONSTANTS.INITIAL_BULLET_COUNT;
            gameState.lastLifeGainedAtScore = 0;
            gameState.silverEnemyActive = false;
            gameState.silverEnemyTimer = 0;
            gameState.nextSilverEnemyScore = GAME_CONSTANTS.SILVER_ENEMY_BASE_SCORE_TRIGGER;
            
            // Clear existing dynamic objects
            gameState.enemies.forEach(enemy => scene.remove(enemy));
            gameState.enemies = [];
            gameState.bullets.forEach(bullet => scene.remove(bullet));
            gameState.bullets = [];
            gameState.enemyBullets.forEach(bullet => scene.remove(bullet));
            gameState.enemyBullets = [];

            player.position.x = 0;
            
            updateScoreUI(0); // Resets score display
            updateHealthUI();
            updateBulletDisplayUI();

            camera.position.set(0, 2, 5); // Ensure camera is correctly positioned
            camera.lookAt(0, 0, -10);

            console.log('Game started/restarted.');
        }
        
        // Event Handlers
        function handleResize() {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            camera.aspect = viewportWidth / viewportHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(viewportWidth, viewportHeight);
            
            // Adjust pixel ratio based on device
            const pixelRatio = (isMobile || isIOS) ? Math.min(window.devicePixelRatio * 0.6, 1.0) : Math.min(window.devicePixelRatio, 2.0);
            renderer.setPixelRatio(pixelRatio);

            if (domElements.controlsBar) {
                domElements.controlsBar.style.bottom = `${Math.max(20, viewportHeight * 0.05)}px`;
            }
            console.log(`Resized. Viewport: ${viewportWidth}x${viewportHeight}, PixelRatio: ${pixelRatio}`);
        }

        function showInfoModal() {
            domElements.infoModal.style.display = 'flex';
        }
        
        function hideInfoModal() {
            domElements.infoModal.style.display = 'none';
            setTimeout(handleResize, 100); // Adjust layout after modal closes
        }

        // Global sound toggle accessible from HTML
        function toggleSoundGlobal() {
            SoundManager.toggle();
        }
        
        // Setup Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('start-btn').addEventListener('click', startGame);
            document.getElementById('play-again-btn').addEventListener('click', startGame); 
            
            document.getElementById('info-btn-start').addEventListener('click', showInfoModal);
            // document.getElementById('info-btn-gameover').addEventListener('click', showInfoModal); // Removed as element no longer exists
            const infoBtnStart = document.getElementById('info-btn-start');
            if (infoBtnStart) {
                infoBtnStart.addEventListener('click', showInfoModal);
            } else {
                console.error("'info-btn-start' not found during DOMContentLoaded!");
            }
            document.getElementById('close-modal').addEventListener('click', hideInfoModal);
            
            domElements.soundToggleBtn.addEventListener('click', toggleSoundGlobal);

            // Mobile controls
            document.getElementById('left-btn').addEventListener('touchstart', (e) => { e.preventDefault(); gameState.moveLeft = true; });
            document.getElementById('left-btn').addEventListener('touchend', (e) => { e.preventDefault(); gameState.moveLeft = false; });
            document.getElementById('right-btn').addEventListener('touchstart', (e) => { e.preventDefault(); gameState.moveRight = true; });
            document.getElementById('right-btn').addEventListener('touchend', (e) => { e.preventDefault(); gameState.moveRight = false; });
            document.getElementById('fire-btn').addEventListener('touchstart', (e) => { e.preventDefault(); fireBullet(); });

            // Desktop controls
            document.addEventListener('keydown', (e) => {
                if (gameState.gameOver || !gameState.gameStarted) return;
                if (e.code === 'Space' || e.key === ' ') fireBullet(); // Added e.key for space as well
                else if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') gameState.moveLeft = true;
                else if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') gameState.moveRight = true;
            });
            document.addEventListener('keyup', (e) => {
                // Check if e.key is a string before calling toLowerCase
                const keyLower = typeof e.key === 'string' ? e.key.toLowerCase() : '';

                if (e.key === 'ArrowLeft' || keyLower === 'a') {
                    gameState.moveLeft = false;
                } else if (e.key === 'ArrowRight' || keyLower === 'd') {
                    gameState.moveRight = false;
                }
            });

            window.addEventListener('resize', handleResize);
            window.addEventListener('orientationchange', handleResize);
            
            handleResize(); 
            updateHealthUI(); 
            updateBulletDisplayUI(); 
            domElements.startScreen.style.display = 'flex'; 
        });
        
        // animate(); // Old way to start the loop
        renderer.setAnimationLoop(animate); // Start the new game loop with Three.js
    // Leaderboard functionality
class Leaderboard {
    constructor() {
        this.apiUrl = 'https://spc-ent-leaderboard.robbyayres.workers.dev';
        this.currentDevice = this.detectDevice();
        this.currentMonth = this.getCurrentMonth();
    }

    detectDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
            ? 'mobile' 
            : 'desktop';
    }

    getCurrentMonth() {
        const date = new Date();
        return date.toLocaleString('default', { month: 'long' }) + ' ' + date.getFullYear();
    }

    async checkHighScore(score) {
        try {
            const response = await fetch(
                `${this.apiUrl}/api/check-score?score=${score}&deviceType=${this.currentDevice}`
            );
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const data = await response.json();
            return data.qualifies || false;
        } catch (error) {
            console.error('Failed to check high score:', error);
            return false;
        }
    }

    async submitScore(name, score) {
        try {
            const response = await fetch(`${this.apiUrl}/api/score`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name: name.substring(0, 5).toUpperCase(),
                    score: Math.floor(score),
                    deviceType: this.currentDevice
                }),
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to submit score: ${errorText}`);
            }
            const result = await response.json();
            return result;
        } catch (error) {
            console.error('Failed to submit score:', error);
            return { success: false, error: error.message };
        }
    }

    async getLeaderboard(deviceType = this.currentDevice) {
        try {
            const response = await fetch(
                `${this.apiUrl}/api/leaderboard?deviceType=${deviceType}`
            );
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Failed to load leaderboard:', error);
            return [];
        }
    }
}

// Initialize leaderboard
window.leaderboardInstance = new Leaderboard();
    const leaderboard = window.leaderboardInstance; // Keep local for convenience if used heavily in this immediate scope

// Show leaderboard function
window.showLeaderboard = async function(deviceType) { // Exposed to window
    // Ensure leaderboardInstance is used internally
    const currentLeaderboardInstance = window.leaderboardInstance; 
    if (!currentLeaderboardInstance) {
        console.error("Leaderboard instance not found on window object for showLeaderboard.");
        document.getElementById('leaderboard-list').innerHTML = '<div class="leaderboard-empty">Leaderboard system error.</div>';
        return;
    }

    try {
        // Default to the current device if none specified
        deviceType = deviceType || currentLeaderboardInstance.currentDevice;
        
        // Update active tab
        document.querySelectorAll('.leaderboard-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        const activeTabElement = document.getElementById(`tab-${deviceType}`);
        if (activeTabElement) {
            activeTabElement.classList.add('active');
        } else {
            console.warn(`Tab element for device type '${deviceType}' not found.`);
        }
        
        // Get and display scores
        const scores = await currentLeaderboardInstance.getLeaderboard(deviceType);
        const container = document.getElementById('leaderboard-list');
        container.innerHTML = ''; // Clear previous scores
        
        if (!scores || scores.length === 0) {
            container.innerHTML = '<div class="leaderboard-empty">No scores yet for this month!</div>';
            // Do not return here, still need to update month title
        } else {
            scores.forEach((entry, index) => {
                const row = document.createElement('div');
                row.className = 'leaderboard-row' + (index < 3 ? ' top-three' : '');
                row.innerHTML = `
                    <span class="rank">${index + 1}</span>
                    <span class="name">${entry.name}</span>
                    <span class="score">${entry.score}</span>
                `;
                container.appendChild(row);
            });
        }
        
        // Update month title
        document.getElementById('current-month').textContent = currentLeaderboardInstance.getCurrentMonth();
    } catch (error) {
        console.error('Error showing leaderboard:', error);
        document.getElementById('leaderboard-list').innerHTML = 
            '<div class="leaderboard-empty">Error loading leaderboard. Please try again later.</div>';
    }
};

// Store original endGame function
const originalEndGame = endGame;

// New combined endGame function
async function endGame() { // Made async to await leaderboard calls
    gameState.gameOver = true;
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
    }

    SoundManager.stopAllSounds({ except: 'game-over-sound' });
    SoundManager.play('game-over-sound');

    const baseScore = gameState.score;
    const bulletsRemaining = gameState.bulletCount;
    const bonusPoints = bulletsRemaining * GAME_CONSTANTS.BONUS_POINTS_PER_BULLET;
    const finalScoreWithBonus = baseScore + bonusPoints;

    // Populate the new combined score display elements
    document.getElementById('base-score-display').textContent = baseScore;
    document.getElementById('bonus-bullets-display').textContent = bulletsRemaining; // Assuming this is part of the bonus calculation display
    document.getElementById('final-score-display').textContent = finalScoreWithBonus;

    // Show the main combined leaderboard screen
    document.getElementById('leaderboardScreen').style.display = 'flex';
    
    if (window.leaderboardInstance && window.showLeaderboard) {
        try {
            const qualifies = await window.leaderboardInstance.checkHighScore(finalScoreWithBonus);
            if (qualifies) {
                document.getElementById('high-score-alert').style.display = 'block';
                document.getElementById('high-score-form').style.display = 'block';
                document.getElementById('leaderboard-container').style.display = 'none'; 
            } else {
                document.getElementById('high-score-alert').style.display = 'none';
                document.getElementById('high-score-form').style.display = 'none';
                document.getElementById('leaderboard-container').style.display = 'block';
                await window.showLeaderboard(); 
            }
        } catch (error) {
            console.error("Error during leaderboard check/display:", error);
            document.getElementById('high-score-alert').style.display = 'none';
            document.getElementById('high-score-form').style.display = 'none';
            document.getElementById('leaderboard-container').style.display = 'block'; 
            document.getElementById('leaderboard-message').textContent = 'Error loading leaderboard.';
        }
    } else {
        console.error("Leaderboard instance or showLeaderboard function not available on window object.");
        document.getElementById('leaderboard-container').style.display = 'block'; 
        document.getElementById('leaderboard-message').textContent = 'Leaderboard system error.';
    }
}

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    document.getElementById('info-btn-leaderboard').addEventListener('click', showInfoModal);
    document.getElementById('tab-desktop').addEventListener('click', () => window.showLeaderboard('desktop'));
    document.getElementById('tab-mobile').addEventListener('click', () => window.showLeaderboard('mobile'));
    
    // Score submission
    document.getElementById('submit-score-btn').addEventListener('click', async function() {
        const nameInput = document.getElementById('player-name');
        const name = nameInput.value.trim();
        if (!name) return;
        
        const score = parseInt(document.getElementById('final-score-display').textContent); // Use the new span for final score
        const result = await leaderboard.submitScore(name, score);
        
        if (result.success) {
            document.getElementById('high-score-form').style.display = 'none';
            document.getElementById('high-score-alert').style.display = 'none';
            document.getElementById('leaderboard-container').style.display = 'block';
            await window.showLeaderboard(); // Call the globally exposed function
        }
    });
    
    // Play again button
    document.getElementById('play-again-btn').addEventListener('click', function() {
        document.getElementById('leaderboardScreen').style.display = 'none';
        startGame();
    });
});
    </script>
    <!-- leaderboard ui -->
    <div id="leaderboardScreen" style="display: none; /* Other styles applied by CSS */">
        <div id="leaderboard-content-wrapper"> <!-- ADD THIS OPENING TAG -->
            <h2>GAME OVER</h2>
            
            <div class="score-display">
                Score: <span id="base-score-display">0</span> + bonus (8 × <span id="bonus-bullets-display">0</span>) = <span id="final-score-display">0</span>
            </div>
            
            <div id="high-score-alert" style="display: none;">
                <h3>NEW HIGH SCORE!</h3>
            </div>
            
            <div id="high-score-form" style="display: none;">
                <p>Enter your name (max 5 chars):</p>
                <div style="display: flex; justify-content: center; align-items: center; margin-top: 18px;">
                    <input type="text" id="player-name" maxlength="5" style="padding: 5px; width: 120px; text-transform: uppercase;">
                    <button id="submit-score-btn" style="margin-left: 10px;">Submit</button>
                </div>
            </div>
            
            <div id="leaderboard-container" style="display: block;"> 
                <h3>High Scores - <span id="current-month"></span></h3>
                <div class="leaderboard-tabs">
                    <button id="tab-desktop" class="leaderboard-tab active">Desktop</button>
                    <button id="tab-mobile" class="leaderboard-tab">Mobile</button>
                </div>
                <div id="leaderboard-list">
                    <!-- Scores will be populated here by JS -->
                </div>
                <div id="leaderboardTableBody\"></div> 
                <div id="leaderboard-message" style="text-align: center; margin-top: 10px;"></div>
            </div>
            
            <button id="play-again-btn">Play Again</button>
            <button id="info-btn-leaderboard" class="info-button-leaderboard">info</button>
        </div> <!-- ADD THIS CLOSING TAG -->
    </div>
<script>
// --- Star Wars Crawl Logic ---
document.addEventListener('DOMContentLoaded', () => {
    const crawlContainer = document.getElementById('star-wars-crawl-container');
    const crawlContent = document.getElementById('star-wars-crawl-content');
    window.crawlHasPlayed = false; // Global flag, accessible from your game logic
    // --- Write Modal Logic ---
    const writeModal = document.getElementById('write-modal');
    const openWriteModalButton = document.getElementById('open-write-modal-button');
    const closeWriteModalButton = document.getElementById('close-write-modal-button');
    const textBlocksContainer = document.getElementById('text-blocks-container');
    const newTextBlockButton = document.getElementById('new-text-block-button');
    const saveCrawlTextButton = document.getElementById('save-crawl-text-button');
    const infoModal = document.getElementById('info-modal'); // Already used elsewhere, but good to have here.

    let textBlockCount = 0;
    const MAX_BLOCKS = 10;
    const MAX_CHARS_PER_BLOCK = 500;
    let crawlTexts = []; // To store saved texts
    const fixedAnimationDurationSeconds = 45.0; // Duration for each crawl block
    let currentCrawlBlockIndex = 0;
    let activeCrawlTexts = [];
    let animationEndHandler; // To store the event handler function for removal
    let isCrawlSequenceActive = false; // Flag to indicate if a crawl sequence is currently playing

    function populateWriteModalFromSavedTexts() {
        if (!textBlocksContainer) return;
        // Clear any existing blocks that might be in the DOM (e.g. if HTML was saved with empty template blocks)
        textBlocksContainer.innerHTML = '';
        textBlockCount = 0; // Reset counter

        if (crawlTexts && crawlTexts.length > 0) {
            console.log('Populating write modal from saved crawlTexts:', crawlTexts);
            crawlTexts.forEach(text => {
                if (textBlockCount < MAX_BLOCKS) {
                    addTextBlock(false, text.text, text.align); // isInitialBlock is false, pass the text and alignment
                }
            });
        }
        // Ensure the 'New Block' button visibility is correct after populating
        if (newTextBlockButton) {
            newTextBlockButton.style.display = textBlockCount >= MAX_BLOCKS ? 'none' : 'inline-block';
        }
        updateSaveButtonState(); // Update save button based on populated texts
    }

    function createTextBlockElement(initialText = '', initialAlign = 'justify') {
        textBlockCount++; // Keep for unique IDs and initial label
        const blockId = `text-block-${textBlockCount}`;
        const textAreaId = `textarea-${textBlockCount}`;
        const charCountId = `char-count-${textBlockCount}`;

        const blockDiv = document.createElement('div');
        blockDiv.id = blockId;
        blockDiv.className = 'text-block-editor-item'; // Use new class

        // 1. Block Label
        const blockLabel = document.createElement('label');
        blockLabel.className = 'block-label';
        blockLabel.textContent = `Text Block ${textBlockCount}`;
        blockLabel.htmlFor = textAreaId; // Good practice for accessibility
        blockDiv.appendChild(blockLabel);

        // 2. Textarea
        const textarea = document.createElement('textarea');
        textarea.id = textAreaId;
        textarea.className = 'block-textarea'; // Use new class
        textarea.value = initialText;
        textarea.setAttribute('maxlength', MAX_CHARS_PER_BLOCK.toString());
        textarea.placeholder = `Enter text for block ${textBlockCount}...`; // Slightly more descriptive
        blockDiv.appendChild(textarea);

        // 3. Controls Row
        const controlsRow = document.createElement('div');
        controlsRow.className = 'controls-row';

        // 3a. Alignment Group (Label + Select)
        const alignmentGroup = document.createElement('div');
        alignmentGroup.className = 'alignment-group';

        const alignmentLabelEl = document.createElement('label'); // Renamed to avoid conflict
        alignmentLabelEl.className = 'alignment-label';
        alignmentLabelEl.textContent = 'Align:'; // Shorter label
        // alignmentLabelEl.htmlFor = `alignment-select-${textBlockCount}`; // For accessibility
        alignmentGroup.appendChild(alignmentLabelEl);

        const alignmentSelect = document.createElement('select');
        alignmentSelect.className = 'alignment-select'; // Existing class, styled via CSS
        // alignmentSelect.id = `alignment-select-${textBlockCount}`;

        const justifyOption = document.createElement('option');
        justifyOption.value = 'justify';
        justifyOption.textContent = 'Justify';
        alignmentSelect.appendChild(justifyOption);

        const centerOption = document.createElement('option');
        centerOption.value = 'center';
        centerOption.textContent = 'Center';
        alignmentSelect.appendChild(centerOption);

        alignmentSelect.value = initialAlign;
        alignmentGroup.appendChild(alignmentSelect);
        controlsRow.appendChild(alignmentGroup);

        // 3b. Character Counter
        const charCounter = document.createElement('div');
        charCounter.id = charCountId; // Keep ID if used elsewhere, though class handles styling
        charCounter.className = 'char-counter'; // Use new class
        charCounter.textContent = `${initialText.length}/${MAX_CHARS_PER_BLOCK}`;
        controlsRow.appendChild(charCounter);

        // Event listener for textarea input (char count update)
        textarea.addEventListener('input', () => {
            const currentLength = textarea.value.length;
            charCounter.textContent = `${currentLength}/${MAX_CHARS_PER_BLOCK}`;
            if (currentLength > MAX_CHARS_PER_BLOCK) {
                charCounter.style.color = 'red'; // Keep dynamic style for error state
            } else {
                charCounter.style.color = ''; // Revert to CSS class color
            }
            updateSaveButtonState(); // Assumed function
        });

        blockDiv.appendChild(controlsRow);

        return blockDiv;
    }

    function addTextBlock(isInitialBlock, text = '', align = 'justify') {
        if (textBlockCount >= MAX_BLOCKS) {
            newTextBlockButton.style.display = 'none'; // Hide button if max blocks reached
            return;
        }
        
        const newBlockElement = createTextBlockElement(text, align);
        textBlocksContainer.appendChild(newBlockElement);

        if (textBlockCount >= MAX_BLOCKS) {
            newTextBlockButton.style.display = 'none';
        } else {
            newTextBlockButton.style.display = 'inline-block';
        }
        updateSaveButtonState();
    }

    function openWriteModal() {
        if (infoModal) infoModal.style.display = 'none';
        writeModal.style.display = 'flex'; // Use flex to center content
        if (textBlocksContainer.children.length === 0) { // Only add initial block if container is empty
            addTextBlock(true);
        }
    }

    function closeWriteModal() {
        writeModal.style.display = 'none';
    }

    if (openWriteModalButton) {
        openWriteModalButton.addEventListener('click', openWriteModal);
    }
    function handleCloseModalButtonClick() {
        const textsProcessed = processAndStoreCrawlTexts();
        if (textsProcessed) {
            console.log('Processing texts from close action:', crawlTexts);
            initiateStarWarsCrawlSequence(crawlTexts);
        } else {
            console.log('No valid text to process from close action. Crawl will not play.');
            if(crawlContainer) crawlContainer.style.display = 'none';
            window.crawlHasPlayed = true;
            isCrawlSequenceActive = false;
        }
        closeWriteModal();
    }

    if (closeWriteModalButton) {
        closeWriteModalButton.addEventListener('click', handleCloseModalButtonClick);
    }
    if (newTextBlockButton) {
        newTextBlockButton.addEventListener('click', () => addTextBlock(false));
    }

    // Populate modal from any saved texts first, then set initial UI states
    populateWriteModalFromSavedTexts();

    // Initial state for newTextBlockButton and save button
    if (newTextBlockButton) {
      if (textBlockCount >= MAX_BLOCKS) {
          newTextBlockButton.style.display = 'none';
      } else {
          newTextBlockButton.style.display = 'inline-block';
      }
    }
    updateSaveButtonState(); // Call initially to set state

    function updateCrawlTextsArray() {
        console.log('Updating crawlTexts array after block removal...');
        processAndStoreCrawlTexts();
        // Optionally, log the updated crawlTexts for debugging
        // console.log('Updated crawlTexts:', crawlTexts);
    }

    function processAndStoreCrawlTexts() {
        crawlTexts = []; // Clear previous texts
        const blockElements = textBlocksContainer.querySelectorAll(':scope > div[id^="text-block-"]');
        let validTextsFound = false;

        blockElements.forEach(blockDiv => {
            const textarea = blockDiv.querySelector('textarea');
            const alignmentSelect = blockDiv.querySelector('.alignment-select');
            if (textarea && alignmentSelect) {
                const text = textarea.value.trim();
                const align = alignmentSelect.value;
                if (text.length > 0 && text.length <= MAX_CHARS_PER_BLOCK) {
                    crawlTexts.push({ text: text, align: align });
                    validTextsFound = true;
                }
            } else {
                console.warn('Textarea or alignment select not found in block:', blockDiv);
            }
        });

        return validTextsFound;
    }

    function updateSaveButtonState() {
        if (!saveCrawlTextButton || !textBlocksContainer) return;

        const textareas = textBlocksContainer.getElementsByTagName('textarea');
        let allTextsValid = true;
        let atLeastOneNonEmptyBlock = false;

        if (textareas.length === 0) {
            allTextsValid = false; // No blocks to save
        } else {
            for (let i = 0; i < textareas.length; i++) {
                const text = textareas[i].value;
                if (text.length > MAX_CHARS_PER_BLOCK) {
                    allTextsValid = false;
                    break;
                }
                if (text.trim().length > 0) {
                    atLeastOneNonEmptyBlock = true;
                }
            }
        }
        
        saveCrawlTextButton.disabled = !(allTextsValid && atLeastOneNonEmptyBlock);
        saveCrawlTextButton.style.opacity = saveCrawlTextButton.disabled ? 0.5 : 1;
        saveCrawlTextButton.style.cursor = saveCrawlTextButton.disabled ? 'not-allowed' : 'pointer';
    }

    function handleSaveButtonClick() {
        const textsProcessed = processAndStoreCrawlTexts(); // Updates global crawlTexts

        const originalModalDisplay = writeModal.style.display;
        writeModal.style.display = 'none'; // Ensure modal is closed for HTML capture

        try {
            let currentHtml = document.documentElement.outerHTML;
            writeModal.style.display = originalModalDisplay; // Restore modal display for current session

            // --- Reset Game State and UI for Saved File ---
            const defaultGameStateValues = {
                score: 0,
                health: 'GAME_CONSTANTS.INITIAL_HEALTH',
                enemies: [],
                bullets: [],
                enemyBullets: [],
                gameOver: false,
                gameStarted: false,
                lastEnemySpawnTime: 0,
                bulletCount: 'GAME_CONSTANTS.INITIAL_BULLET_COUNT',
                lastLifeGainedAtScore: 0,
                silverEnemyActive: false,
                silverEnemyTimer: 0,
                nextSilverEnemyScore: 'GAME_CONSTANTS.SILVER_ENEMY_BASE_SCORE_TRIGGER',
            };

            // --- Nuke and Rebuild gameState --- 
            const defaultGameStateString = `const gameState = {
                score: 0,
                health: GAME_CONSTANTS.INITIAL_HEALTH,
                enemies: [],
                bullets: [],
                enemyBullets: [],
                gameOver: false,
                gameStarted: false,
                moveLeft: false,
                moveRight: false,
                lastEnemySpawnTime: 0,
                bulletCount: GAME_CONSTANTS.INITIAL_BULLET_COUNT,
                lastLifeGainedAtScore: 0,
                silverEnemyActive: false,
                silverEnemyTimer: 0,
                silverEnemyDirection: 1, // Default direction
                nextSilverEnemyScore: GAME_CONSTANTS.SILVER_ENEMY_BASE_SCORE_TRIGGER,
            };`;

            const gameStateRegex = /(const\s+gameState\s*=\s*{[\s\S]*?};)/m;
            if (gameStateRegex.test(currentHtml)) {
                currentHtml = currentHtml.replace(gameStateRegex, defaultGameStateString);
                console.log('gameState object completely reset in HTML for download.');
            } else {
                console.error('Could not find the gameState object definition to replace it. HTML will be saved with potentially old game state.');
                // As a fallback, attempt individual critical resets if the full block replacement fails
                // This is less ideal but better than nothing if the main regex fails.
                currentHtml = currentHtml.replace(/(score\s*:\s*)[^,}]+(?=[,}])/m, '$10');
                currentHtml = currentHtml.replace(/(gameOver\s*:\s*)[^,}]+(?=[,}])/m, '$1false');
                currentHtml = currentHtml.replace(/(gameStarted\s*:\s*)[^,}]+(?=[,}])/m, '$1false');
                currentHtml = currentHtml.replace(/(health\s*:\s*)[^,}]+(?=[,}])/m, '$1GAME_CONSTANTS.INITIAL_HEALTH');
                currentHtml = currentHtml.replace(/(enemies\s*:\s*)\[[\s\S]*?\](?=[,}])/m, '$1[]'); // Reset enemies array
                currentHtml = currentHtml.replace(/(bullets\s*:\s*)\[[\s\S]*?\](?=[,}])/m, '$1[]'); // Reset bullets array
                currentHtml = currentHtml.replace(/(enemyBullets\s*:\s*)\[[\s\S]*?\](?=[,}])/m, '$1[]'); // Reset enemyBullets array
            }

            currentHtml = currentHtml.replace(/(window\.crawlHasPlayed\s*=\s*)[^;]+;/m, '$1false;');
            currentHtml = currentHtml.replace(/(isCrawlSequenceActive\s*=\s*)[^;]+;/m, '$1false;');

            // Reset UI screen visibility
            // For gameOverScreen: ensure display:none
            currentHtml = currentHtml.replace(/(id="game-over"[^>]*)(>)/m, (match, elementTag, endBracket) => {
                if (elementTag.includes('style="')) {
                    return elementTag.replace(/(style=")([^"*]*)(")/m, (styleMatch, styleP1, styleP2, styleP3) => {
                        let styles = styleP2.replace(/display\s*:[^;]+;?/gi, '').trim();
                        if (styles && !styles.endsWith(';')) styles += ';';
                        return `${styleP1}${styles}display:none;${styleP3}${endBracket}`;
                    });
                } else {
                    return `${elementTag} style="display:none;"${endBracket}`;
                }
            });

            // For startScreen: ensure display:flex (or its default visible state)
            currentHtml = currentHtml.replace(/(id="start-screen"[^>]*)(>)/m, (match, elementTag, endBracket) => {
                if (elementTag.includes('style="')) {
                    return elementTag.replace(/(style=")([^"*]*)(")/m, (styleMatch, styleP1, styleP2, styleP3) => {
                        let styles = styleP2.replace(/display\s*:[^;]+;?/gi, '').trim();
                        if (styles && !styles.endsWith(';')) styles += ';';
                        return `${styleP1}${styles}display:flex;${styleP3}${endBracket}`; // Assuming flex for visibility
                    });
                } else {
                    return `${elementTag} style="display:flex;"${endBracket}`; // Assuming flex for visibility
                }
            });
            // --- End Reset Game State and UI ---

            const crawlTextsJSON = JSON.stringify(crawlTexts);
            const crawlEmbedRegex = /(let\s+crawlTexts\s*=\s*)(?:[^;]+)(\s*;\s*\/\/.*)/m;
            const newCrawlTextsInitialization = `$1${crawlTextsJSON}$2`;

            if (crawlEmbedRegex.test(currentHtml)) {
                currentHtml = currentHtml.replace(crawlEmbedRegex, newCrawlTextsInitialization);
                console.log('Crawl texts embedded into HTML for download.');
            } else {
                console.error('Could not find crawlTexts initialization line in HTML to embed saved texts.');
            }

            const blob = new Blob([currentHtml], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'zen-space-entropy.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('HTML download initiated.');

        } catch (error) {
            console.error('Error during HTML save process:', error);
            alert('An error occurred while trying to save the game HTML.');
        }

        // Regardless of download success/failure, try to animate if texts were processed from modal
        if (textsProcessed && crawlTexts.length > 0) {
            console.log('Initiating crawl sequence after save attempt:', crawlTexts);
            initiateStarWarsCrawlSequence(crawlTexts);
        } else if (!textsProcessed) {
            console.log('No new valid text from modal to animate after save attempt. Crawl will not play unless previously set.');
            // If crawlTexts was already populated and textsProcessed is false (modal was empty/invalid),
            // we might still want to play existing crawlTexts if that's desired.
            // For now, only animate if new texts were processed from the modal for this action.
            if(crawlContainer && !isCrawlSequenceActive) {
                 // if no new texts, and no sequence active, ensure it's hidden if it was supposed to be cleared.
                 // This part might need refinement based on desired behavior if modal is submitted empty.
            }
        }
        closeWriteModal();
    }

    if (saveCrawlTextButton) {
        saveCrawlTextButton.addEventListener('click', handleSaveButtonClick);
    }

    function playNextCrawlBlock() {
        console.log('[CRAWL DEBUG] playNextCrawlBlock called. Current Index:', currentCrawlBlockIndex, 'Active Texts:', activeCrawlTexts.length);
        // console.trace('[CRAWL DEBUG] playNextCrawlBlock trace');
        if (!crawlContainer || !crawlContent) return;

        if (currentCrawlBlockIndex >= activeCrawlTexts.length) {
            console.log('All crawl blocks have played.');
            crawlContainer.style.display = 'none';
            window.crawlHasPlayed = true;
            isCrawlSequenceActive = false; // Sequence is no longer active
            if (animationEndHandler) {
                crawlContent.removeEventListener('animationend', animationEndHandler);
            }
            return;
        }

        const currentBlock = activeCrawlTexts[currentCrawlBlockIndex];
        console.log(`Playing crawl block ${currentCrawlBlockIndex + 1}: "${currentBlock.text.substring(0,30)}..." with alignment: ${currentBlock.align}`);
        crawlContent.innerHTML = currentBlock.text.replace(/\n/g, '<br>');
        crawlContent.style.textAlign = currentBlock.align; // Apply alignment
        crawlContainer.style.display = 'block';

        // Reset and restart animation
        crawlContent.style.animation = 'none';
        void crawlContent.offsetWidth; // Trigger reflow
        crawlContent.style.animation = `crawlAnimation ${fixedAnimationDurationSeconds}s linear forwards`;

        currentCrawlBlockIndex++;
    }

    animationEndHandler = playNextCrawlBlock; // Assign the handler

    function initiateStarWarsCrawlSequence(textsToPlay) {
        console.log('[CRAWL DEBUG] initiateStarWarsCrawlSequence called. Texts to play:', textsToPlay ? textsToPlay.length : 0);
        console.trace('[CRAWL DEBUG] initiateStarWarsCrawlSequence trace');
        if (!textsToPlay || textsToPlay.length === 0) {
            console.log("No texts provided for crawl sequence.");
            if (crawlContainer) crawlContainer.style.display = 'none';
            window.crawlHasPlayed = true; // No crawl will occur
            isCrawlSequenceActive = false; // Ensure flag is false if no sequence starts
            return;
        }
        console.log("Initiating new Star Wars crawl sequence.");
        activeCrawlTexts = [...textsToPlay];
        currentCrawlBlockIndex = 0;
        window.crawlHasPlayed = false; // Allow this new sequence to play
        isCrawlSequenceActive = true;   // Mark sequence as active

        if (crawlContent) {
            // Remove any existing listener before adding a new one
            if (animationEndHandler) {
                crawlContent.removeEventListener('animationend', animationEndHandler);
            }
            crawlContent.addEventListener('animationend', animationEndHandler);
        }
        playNextCrawlBlock(); // Start the first block
    }

    // This function is typically called when the game starts.
    // It now triggers the sequence based on saved texts.
    window.startStarWarsCrawl = function() {
        console.log('[CRAWL DEBUG] window.startStarWarsCrawl called. crawlHasPlayed:', window.crawlHasPlayed, 'isCrawlSequenceActive:', isCrawlSequenceActive, 'Saved crawlTexts:', crawlTexts.length);
        // console.trace('[CRAWL DEBUG] window.startStarWarsCrawl trace'); // Keep trace for deeper debug if needed, but log is often enough

        if (isCrawlSequenceActive) {
            console.log('[CRAWL DEBUG] startStarWarsCrawl: Sequence already active. Exiting.');
            return;
        }
        if (window.crawlHasPlayed) {
            console.log("Crawl sequence has already completed or is in progress.");
            return;
        }
        if (crawlTexts && crawlTexts.length > 0) {
            console.log("Game start: Triggering saved Star Wars crawl sequence.");
            initiateStarWarsCrawlSequence(crawlTexts);
        } else {
            console.log("Game start: No saved crawl text. Crawl will not play.");
            if (crawlContainer) crawlContainer.style.display = 'none';
            window.crawlHasPlayed = true; // Mark as 'nothing to play'
        }
    };

    // Placeholder text is no longer directly used by startStarWarsCrawl, but keep for reference or other uses if any.
    const placeholderCrawlText = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam. (almost 500)";

    window.resetStarWarsCrawl = function() {
        console.log('[CRAWL DEBUG] window.resetStarWarsCrawl called.');
        console.trace('[CRAWL DEBUG] window.resetStarWarsCrawl trace');
        console.log("Resetting Star Wars crawl state.");
        window.crawlHasPlayed = false;
        isCrawlSequenceActive = false; // Also reset this flag
        if (crawlContainer) {
            crawlContainer.style.display = 'none';
        }
        if (crawlContent) {
            crawlContent.style.animation = ''; // Clear animation style
        }
    };

    // --- INTEGRATION POINT --- 
    // TO BE DONE BY YOU in your game's specific logic files/sections:
    
    // 1. In your function that updates the score:
    //    (Example assuming 'currentScore' is the variable holding the player's score)
    /*
    if (currentScore >= 100 && !window.crawlHasPlayed) {
        window.startStarWarsCrawl();
    }
    */

    // 2. In your function that resets the game (e.g., when 'Play Again' is clicked):
    /*
    window.resetStarWarsCrawl();
    */
    
    // Example for standalone testing of the crawl (you can remove this block later):
    
    setTimeout(() => {
        if (!window.crawlHasPlayed) { // Check flag before auto-starting for test
             console.log("Simulating score >= 100 for crawl test after 5s.");
             window.startStarWarsCrawl();
        }
    }, 5000); // Trigger crawl after 5 seconds for quick visual test
    /*
    // Example to test reset (you can remove this block later):
    setTimeout(() => {
        console.log("Simulating game reset after 15s to test crawl reset.");
        window.resetStarWarsCrawl();
        // You could then call startStarWarsCrawl() again if score condition met
    }, 15000);
    */
});
// --- End of Star Wars Crawl Logic ---
</script>
</body>
</html>